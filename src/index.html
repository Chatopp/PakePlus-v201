<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aiè™šæ‹Ÿå»ºæ„ç”Ÿç‰©è†œæ¨¡å‹å¹³å° - äº¤äº’å¼æ•™å­¦ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden; /* é¡µé¢ä¸å‡ºç°æ¨ªå‘æ»šåŠ¨ */
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: #1565c0;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .header p {
            color: #546e7a;
            font-size: 1.1em;
        }

        .header .meta-author {
            color: #78909c;
            font-size: 0.95em;
            margin-top: 4px;
        }

        .main-content {
            display: grid;
            grid-template-columns: minmax(0, 1fr) clamp(280px, 32vw, 380px); /* æ”¾å¤§å³ä¾§ä¿¡æ¯é¢æ¿ï¼Œä»¥ä¾¿ AI åŒºåŸŸæ›´å®½ */
            grid-template-rows: auto 1fr;     /* é¡¶éƒ¨ç»„ä»¶æ  + ä¸‹æ–¹ç”»å¸ƒ */
            gap: 12px;                        /* ä¸Šä¸‹é—´è·æ›´ç´§å‡‘ */
            align-items: start;
        }

        .component-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            height: fit-content;
            grid-column: 1;
            grid-row: 1;
        }

        .component-strip {
            display: flex;                    /* å•æ’æ°´å¹³æ’åˆ— */
            flex-wrap: nowrap;                /* ä¸æ¢è¡Œï¼Œè¶…å‡ºåˆ™æ»šåŠ¨ */
            gap: 6px;                         /* ç¼©å°å¡ç‰‡é—´è· */
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            overscroll-behavior-x: contain;   /* åªåœ¨æ­¤å¤„æ°´å¹³æ»šåŠ¨ï¼Œä¸è”åŠ¨é¡µé¢ */
            touch-action: pan-x;              /* å…è®¸åœ¨ç»„ä»¶æ¡æ¨ªå‘æ»‘åŠ¨ */
        }
        .component-strip::-webkit-scrollbar { height: 8px; }
        .component-strip::-webkit-scrollbar-thumb { background: #c5d7f2; border-radius: 8px; }
        .component-strip::-webkit-scrollbar-track { background: #eef3fb; }

        .component-panel h2 {
            color: #1565c0;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #e3f2fd;
        }

        .component-item {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 6px;                     /* æ›´ç´§å‡‘çš„å†…è¾¹è· */
            margin-bottom: 0;
            cursor: grab;
            transition: all 0.3s ease;
            position: relative;
            user-select: none;
            width: 100px;       /* å°æ­£æ–¹å½¢å¡ç‰‡ */
            min-width: 100px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        .component-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
            border-color: #2196f3;
            background: #e3f2fd;
        }

        .component-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .component-item.selected {
            border-color: #1976d2;
            background: #e3f2fd;
            box-shadow: 0 4px 12px rgba(25,118,210,0.25);
        }

        .component-visual {
            width: 100%;
            height: 56px;                     /* å°æ­£æ–¹å½¢ä¸­æ›´æ¸…æ™°çš„é¢„è§ˆåŒº */
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .component-visual svg { width: 48px; height: 48px; }

        .component-name {
            display: block;                   /* ç®€çŸ­åç§°æ˜¾ç¤º */
            width: 100%;
            text-align: center;
            font-weight: 600;
            color: #37474f;
            font-size: 11px;                 /* æ›´å°å­—å· */
            line-height: 1.1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .component-desc { display: none; }

        /* ç»„ä»¶å¡ç‰‡ä¸Šçš„æ‰¹é‡æ”¾ç½®å°å¼€å…³ */
        .bulk-chip {
            position: absolute;
            top: 6px;
            right: 6px;
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 12px;
            background: #e9eef6;
            color: #0f172a;
            border: 1px solid #cfd8e3;
            cursor: pointer;
            line-height: 1.4;
            touch-action: manipulation;
            user-select: none;
        }
        .bulk-chip.active { background: #cfe1ff; border-color: #93c5fd; color: #0b3d91; }

        .membrane-builder {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            grid-column: 1;
            grid-row: 2;
        }

        .builder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e3f2fd;
        }

        .builder-header h2 {
            color: #1565c0;
            font-size: 1.4em;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-icon {
            padding: 8px 10px;
            font-size: 12px;
            border-radius: 8px;
            background: #e9eef6;
            color: #0f172a;
        }
        .btn-icon.active { background: #cfe1ff; color: #0b3d91; }

        .btn-preset {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-preset:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-clear {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-clear:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
        }

        .btn-save { background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); color:#fff; }
        .btn-save:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0, 176, 155, 0.35); }
        .btn-load { background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%); color:#fff; }
        .btn-load:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(255, 94, 98, 0.35); }

        

        .btn-motion {
            background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
            color: white;
        }
        .btn-motion.active {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: #0b3d2e;
        }

        .btn-ai {
            background: linear-gradient(135deg, #06b6d4 0%, #2563eb 100%);
            color: #fff;
        }

        #membraneCanvas {
            width: 100%;
            height: 500px;
            background: #ffffff;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            border: 3px dashed #90caf9;
            transition: all 0.3s ease;
            overscroll-behavior: contain; /* é˜²æ­¢è§¦æ§æ»šåŠ¨é“¾åˆ°é¡µé¢ */
            touch-action: none;            /* ç”»å¸ƒè‡ªå®šä¹‰æ‰‹åŠ¿ï¼ˆæ‹–æ‹½/ç¼©æ”¾/ç‚¹å‡»æ”¾ç½®ï¼‰ */
        }

        /* Studio æ¨¡å¼ï¼šæ›´åƒå»ºæ¨¡å¹³å°çš„è§†è§‰ */
        #membraneCanvas.studio {
            background: radial-gradient(1200px 600px at 30% 30%, #111927 0%, #0b1220 60%, #0a0f1a 100%);
            border: 1px solid #243247;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03), 0 10px 30px rgba(0,0,0,0.25);
        }

        /* ç”»å¸ƒå†…å®¹å®¹å™¨ï¼šç»Ÿä¸€ç¼©æ”¾å¯¹è±¡ */
        #canvasContent {
            position: absolute;
            inset: 0;
            transform-origin: center center;
            touch-action: none; /* å…è®¸è‡ªå®šä¹‰å¤šæŒ‡æ‰‹åŠ¿ï¼ˆpinch/panï¼‰ */
        }
        /* ç”»å¸ƒå°ºå¯¸æ‰‹åŠ¨è°ƒèŠ‚æŠŠæ‰‹ */
        .resize-handle { position:absolute; z-index: 100; background: rgba(59,130,246,0.85); opacity:.6; border-radius: 3px; }
        .resize-handle.right { top: 50%; right: 2px; transform: translateY(-50%); width: 8px; height: 80px; cursor: ew-resize; }
        .resize-handle.bottom { left: 50%; bottom: 2px; transform: translateX(-50%); height: 8px; width: 120px; cursor: ns-resize; }
        .resize-handle.corner { right: 2px; bottom: 2px; width: 16px; height: 16px; cursor: nwse-resize; border-radius: 4px; }
        @media (pointer: coarse) {
            .resize-handle.right { width: 14px; height: 120px; right: 4px; }
            .resize-handle.bottom { height: 14px; width: 160px; bottom: 4px; }
            .resize-handle.corner { width: 22px; height: 22px; right: 4px; bottom: 4px; }
        }
        /* ç”»å¸ƒå¼•å¯¼å¡ç‰‡ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼Œæ”¾ç½®ç»„ä»¶åè‡ªåŠ¨éšè—ï¼‰ */
        .canvas-intro { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index: 1; }
        .canvas-intro .intro-card { pointer-events:auto; max-width:min(560px, 86%); background: rgba(255,255,255,0.9); border:1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); padding: 14px 16px; color:#0f172a; }
        .canvas-intro .intro-title { font-weight: 700; margin-bottom: 8px; color:#0b3d91; }
        .canvas-intro ul { padding-left: 18px; }
        .canvas-intro li { font-size: 13px; line-height: 1.6; color:#1f2937; }
        #membraneCanvas.studio .canvas-intro .intro-card { background: rgba(2,6,12,0.8); border-color:#334155; color:#e2e8f0; }
        #membraneCanvas.studio .canvas-intro .intro-title { color:#93c5fd; }

        /* ç½‘æ ¼è¦†ç›–å±‚ï¼ˆè·Ÿéšç¼©æ”¾ï¼‰ */
        .grid-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            opacity: 0.22;
            display: none;
            /* é»˜è®¤ä½¿ç”¨é»‘è‰²ç½‘æ ¼çº¿ï¼Œä¾¿äºåœ¨æµ…è‰²èƒŒæ™¯ä¸Šè¯†åˆ« */
            background-image:
              linear-gradient(rgba(0,0,0,1) 1px, transparent 1px),
              linear-gradient(90deg, rgba(0,0,0,1) 1px, transparent 1px),
              linear-gradient(rgba(0,0,0,1) 1px, transparent 1px),
              linear-gradient(90deg, rgba(0,0,0,1) 1px, transparent 1px);
            /* æ¯ä¸ªå°æ ¼ä¸º 40pxï¼ˆä¸ç£·è„‚å®½åº¦ä¸€è‡´ï¼‰ï¼Œæ¯ 5 æ ¼åŠ ä¸€æ¡è¾ƒç²—çš„ä¸»ç½‘æ ¼çº¿ï¼ˆ200pxï¼‰ */
            background-size: 40px 40px, 40px 40px, 200px 200px, 200px 200px;
            background-position: 0 0, 0 0, 0 0, 0 0;
        }

        /* Studio æš—è‰²å·¥ä½œå°æ—¶ï¼Œæ”¹ä¸ºç™½è‰²ç½‘æ ¼çº¿å¹¶ç¨å¾®æé«˜ä¸é€æ˜åº¦ï¼Œå¢å¼ºå¯è§æ€§ */
        #membraneCanvas.studio .grid-overlay {
            opacity: 0.35;
            background-image:
              linear-gradient(rgba(255,255,255,1) 1px, transparent 1px),
              linear-gradient(90deg, rgba(255,255,255,1) 1px, transparent 1px),
              linear-gradient(rgba(255,255,255,1) 1px, transparent 1px),
              linear-gradient(90deg, rgba(255,255,255,1) 1px, transparent 1px);
        }

        /* åº•éƒ¨çŠ¶æ€æ  */
        .status-bar {
            margin-top: 8px;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            color: #334155;
            background: #f1f5f9;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        #membraneCanvas.studio + .status-bar { background: #0f172a; color: #cbd5e1; border: 1px solid #243247; }

        /* æ“ä½œæç¤º */
        .op-hint {
            margin-top: 10px;
            font-size: 12px;
            color: #607d8b;
            background: #f8fafc;
            border: 1px dashed #e2e8f0;
            padding: 8px 10px;
            border-radius: 8px;
        }

        /* AI æ‚¬æµ®çª— */
        .ai-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.45);
            z-index: 3000; display: none;
        }
        .ai-modal {
            position: fixed; z-index: 3001; display: none;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: min(880px, 96vw); max-height: 92vh;
            background: radial-gradient(1200px 700px at 10% 0%, #0b1220 0%, #0a0f1a 60%, #070c13 100%);
            border-radius: 14px; box-shadow: 0 30px 80px rgba(0,0,0,0.5);
            border: 1px solid rgba(59,130,246,0.25); overflow: hidden; display: flex; flex-direction: column;
        }
        /* é¡µé¢æ¨¡å¼ï¼šä»¥â€œæ•´é¡µç•Œé¢â€å‘ˆç°åŠ©æ‰‹ï¼Œè€Œéæ‚¬æµ®çª— */
        .ai-modal.page-mode {
            top: 0; left: 0; transform: none;
            width: 100vw; height: 100vh; max-height: 100vh; border-radius: 0;
            box-shadow: none; border: none; z-index: 10;
        }
        .hidden { display: none !important; }
        /* é¡¶éƒ¨è¿”å›æŒ‰é’®æ ·å¼ç¨æ˜æ˜¾äº› */
        .ai-back { background: transparent; border: 1px solid rgba(59,130,246,0.35); color:#93c5fd; border-radius: 8px; padding: 6px 10px; cursor:pointer; margin-right:8px; }
        .ai-back:hover { background: rgba(226,232,240,0.08); }
        .ai-modal-header { padding: 10px 12px; background: linear-gradient(180deg, rgba(30,41,59,0.9), rgba(2,6,12,0.9)); border-bottom: 1px solid rgba(59,130,246,0.25); display: flex; align-items:center; justify-content: space-between; cursor: move; user-select: none; }
        .ai-modal-title { font-weight: 800; color: #e2e8f0; letter-spacing: .5px; }
        .ai-close { background: transparent; border: none; font-size: 18px; color: #334155; cursor: pointer; padding: 4px 8px; border-radius: 6px; }
        .ai-close:hover { background: rgba(226,232,240,0.18); color:#e2e8f0; }
        .ai-modal-body { padding: 12px; overflow: hidden; display:flex; flex-direction:column; gap:10px; }

        /* èŠå¤©çª—å£æ ·å¼ */
        .chat-log { flex: 1 1 auto; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; padding: 8px; display: flex; flex-direction: column; gap: 10px; }
        .msg { display: flex; gap: 8px; align-items: flex-end; }
        .msg.ai { justify-content: flex-start; }
        .msg.user { justify-content: flex-end; }
        .bubble { max-width: 72%; padding: 10px 12px; border-radius: 12px; font-size: 14px; line-height: 1.5; box-shadow: 0 6px 18px rgba(0,0,0,0.25); }
        .msg.ai .bubble { background: rgba(30,41,59,0.85); color:#e2e8f0; border: 1px solid rgba(99,102,241,0.25); }
        .msg.user .bubble { background: linear-gradient(135deg, #4f46e5, #06b6d4); color: #fff; border: 1px solid rgba(56,189,248,0.25); }
        .bubble img { display:block; max-width: 280px; border-radius: 10px; margin-bottom: 6px; }
        .typing { width: 36px; height: 14px; display:inline-flex; gap:4px; align-items:center; }
        .typing span { width:6px; height:6px; background:#cbd5e1; border-radius:50%; animation: blink 1.2s infinite ease-in-out; opacity:.5; }
        .typing span:nth-child(2){ animation-delay:.2s }
        .typing span:nth-child(3){ animation-delay:.4s }
        @keyframes blink { 0%,80%,100%{transform:translateY(0);opacity:.4} 40%{transform:translateY(-3px);opacity:1} }

        .chat-input { flex: 0 0 auto; display: flex; gap: 8px; align-items:center; background: rgba(15,23,42,0.6); border: 1px solid rgba(59,130,246,0.25); border-radius: 10px; padding: 8px; }
        .chat-input textarea { flex: 1 1 auto; min-height: 36px; max-height: 120px; resize: vertical; border: none; outline: none; padding: 8px; border-radius: 6px; color:#e2e8f0; background: rgba(2,6,12,0.45); }
        .icon-btn { background: rgba(226,232,240,0.08); border: 1px solid rgba(59,130,246,0.35); color:#93c5fd; border-radius: 8px; padding: 6px 10px; cursor:pointer; }
        .icon-btn:hover { background: rgba(59,130,246,0.18); }
        .send-btn { background: linear-gradient(135deg, #06b6d4, #2563eb); color:#fff; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
        .send-btn:hover { filter: brightness(1.1); }
        .ai-settings { display:none; padding: 10px; border-top: 1px solid rgba(59,130,246,0.25); background: rgba(15,23,42,0.45); }
        .ai-settings .ai-row { gap:10px }
        .ai-settings input { background: rgba(2,6,12,0.6); color:#e2e8f0; border:1px solid rgba(59,130,246,0.3); }
        .ai-settings select { background: rgba(2,6,12,0.6); color:#e2e8f0; border:1px solid rgba(59,130,246,0.3); border-radius:8px; padding:6px 8px; }

        #membraneCanvas.placing {
            cursor: crosshair;
            border-color: #1976d2;
        }

        #membraneCanvas.drag-over {
            border-color: #1976d2;
            background: #ffffff;
            box-shadow: inset 0 0 30px rgba(25, 118, 210, 0.2);
        }

        .membrane-layer {
            position: absolute;
            width: 100%;
            height: 200px;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .placed-component {
            position: absolute;
            cursor: move;
            transition: filter 0.3s ease;
            z-index: 10;
            user-select: none;
            touch-action: none; /* å…ƒç´ è‡ªèº«å“åº”æ‹–æ‹½æ‰‹åŠ¿ï¼Œä¸è§¦å‘æµè§ˆå™¨æ»šåŠ¨ */
        }

        .placed-component:hover {
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3)) brightness(1.1);
            z-index: 20;
        }

        .info-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            height: fit-content;
            grid-column: 2;
            grid-row: 1 / span 2;
            min-width: 240px;
        }

        .info-panel h2 {
            color: #1565c0;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #e3f2fd;
        }

        .stats-grid {
            display: grid;
            gap: 8px; /* æ›´ç´§å‡‘çš„å¡ç‰‡é—´è· */
            grid-template-columns: repeat(2, minmax(0, 1fr));
            align-items: stretch;
        }

        .stat-item {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 6px 8px; /* ç¼©å°å¡ç‰‡å†…è¾¹è· */
            border-radius: 8px; /* æ›´å°åœ†è§’ */
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            min-height: 32px; /* æ§åˆ¶å¡ç‰‡é«˜åº¦æ›´ç´§å‡‘ */
        }

        .stat-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-weight: 600;
            color: #37474f;
            font-size: 0.85em; /* æ–‡æœ¬æ›´å° */
        }

        .stat-value {
            font-weight: 700;
            font-size: 0.95em; /* æ•°å­—æ›´å° */
            color: #1565c0;
            background: white;
            padding: 0 8px; /* ç¼©å°å¾½æ ‡å°ºå¯¸ */
            border-radius: 12px;
            line-height: 1.6;
        }

        .knowledge-card { display: none; }
        .ai-launch { margin-top: 16px; padding: 20px; border-radius: 14px;
            background: linear-gradient(135deg, rgba(6,182,212,0.95), rgba(37,99,235,0.95));
            border: 1px solid rgba(59,130,246,0.45);
            box-shadow: 0 14px 40px rgba(2, 6, 23, 0.35);
            color: #eaf2ff;
        }
        .ai-launch h3 { font-size: 1.24em; color: #ffffff; margin-bottom: 8px; letter-spacing: .3px; display:flex; align-items:center; gap:8px; }
        .ai-launch p { color: #e6f1ff; font-size: 13px; margin-bottom: 10px; opacity:.95 }
        .ai-features { margin: 8px 0 12px; padding-left: 18px; }
        .ai-features li { font-size: 12px; line-height: 1.6; color: #f1f5ff; }

        /* AI å­¦ä¹ åŠ©æ‰‹é¢æ¿ */
        .ai-panel {
            margin-top: 16px;
            padding: 14px;
            border-radius: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
        }
        .ai-panel h2 {
            font-size: 1.1em;
            color: #0f172a;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ai-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .ai-panel textarea {
            width: 100%;
            min-height: 78px;
            resize: vertical;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #cfd8e3;
            outline: none;
        }
        .ai-panel input[type="text"],
        .ai-panel input[type="password"] {
            flex: 1 1 150px;
            min-width: 150px;
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid #cfd8e3;
            outline: none;
            font-size: 12px;
        }
        .ai-panel input[type="file"] { flex: 1 1 160px; min-width: 160px; }
        .ai-actions { margin-top: 8px; display: flex; gap: 8px; }
        .ai-btn { padding: 6px 10px; border: 1px solid #cfd8e3; background: #e9eef6; color: #0f172a; border-radius: 8px; cursor: pointer; font-size: 12px; }
        .ai-btn.primary { background: #3b82f6; color: #fff; border-color: #3b82f6; }
        .ai-status { margin-top: 6px; font-size: 12px; color: #64748b; }
        .ai-response { margin-top: 10px; padding: 10px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 13px; color: #0f172a; white-space: pre-wrap; }

        .tooltip {
            position: absolute;
            background: rgba(33, 33, 33, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(5px);
        }

        /* åˆ é™¤åŒå‡»åˆ é™¤çš„æç¤ºï¼Œé¿å…é®æŒ¡è§†é‡ */

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .floating { animation: float 3s ease-in-out infinite; }
        .pulsing { animation: pulse 2s ease-in-out infinite; }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            .component-panel { grid-column: 1; grid-row: 1; }
            .membrane-builder { grid-column: 1; grid-row: 2; }
            .info-panel { grid-column: 1; grid-row: 3; max-width: 100%; }
        }
    </style>
    <style>
        /* === å¹³æ¿ä¸ä¸€ä½“æœºé€‚é…å¢å¼ºï¼ˆä¸ä¼šå½±å“åŸæœ‰å¸ƒå±€ï¼Œä»…åšè¦†ç›–ï¼‰ === */
        body {
            -webkit-text-size-adjust: 100%;
            padding-left: calc(20px + env(safe-area-inset-left));
            padding-right: calc(20px + env(safe-area-inset-right));
            padding-top: calc(20px + env(safe-area-inset-top));
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }
        .container { max-width: 1760px; }
        .component-strip { scroll-snap-type: x proximity; }
        .component-strip > .component-item { scroll-snap-align: start; }
        /* ç”»å¸ƒé«˜åº¦éšè§†å£ä¼¸ç¼©ï¼ˆå°å±ä¸æŒ¤ï¼Œå¤§å±ä¸æµªè´¹ï¼‰ */
        #membraneCanvas { height: clamp(380px, 56vh, 780px); }

        /* è§¦æ§è®¾å¤‡ï¼šå¢å¤§è§¦è¾¾é¢ç§¯ä¸ç”»å¸ƒ */
        @media (pointer: coarse) {
            .btn { padding: 12px 22px; font-size: 15px; min-height: 40px; }
            .btn-icon { padding: 10px 12px; font-size: 13px; }
            .component-item { width: 120px; min-width: 120px; height: 120px; }
            .component-visual svg { width: 56px; height: 56px; }
            .component-name { font-size: 12px; }
            #membraneCanvas { height: min(64vh, 800px); }
        }

        /* å¤§å±ä¸€ä½“æœºï¼šæ›´é«˜ç”»å¸ƒã€æ›´å®½å®¹å™¨ä¸ç•¥å¤§ç»„ä»¶ */
        @media (min-width: 1600px) {
            .container { max-width: 1840px; }
            #membraneCanvas { height: clamp(540px, 60vh, 900px); }
            .component-item { width: 110px; min-width: 110px; height: 110px; }
            .component-visual svg { width: 54px; height: 54px; }
        }
    </style>
    </head>
<body>
    <div class="container">
        <div class="header">
            <h1>Aiè™šæ‹Ÿå»ºæ„ç”Ÿç‰©è†œæ¨¡å‹å¹³å°&äº¤äº’å¼æ•™å­¦ç³»ç»Ÿ</h1>
            <div class="meta-author">åˆ¶ä½œä¿¡æ¯ï¼šé¥¶åç¥¯ Â· å¹¿æ˜Œå¿ç¬¬ä¸€ä¸­å­¦</div>
        </div>

        <div class="main-content">
            <div class="component-panel">
                <h2>ğŸ“¦ è†œç»“æ„ç»„ä»¶</h2>
                <div class="op-hint">æ“ä½œæç¤ºï¼šç‚¹å‡»/è½»è§¦å·¦ä¾§ç»„ä»¶é€‰æ‹© â†’ ç”»å¸ƒç‚¹å‡»/è½»è§¦æ”¾ç½®ï¼ˆäº¦å¯æ‹–æ‹½ï¼‰ï¼›åŒå‡»/åŒå‡»ç»„ä»¶å¯åˆ é™¤ã€‚è‹¥éœ€ä¸€æ¬¡æ€§æ·»åŠ  5 ä¸ªç£·è„‚ï¼Œè¯·ç‚¹å‡»å·¦ä¾§â€œç£·è„‚(æ­£/å€’)â€å¡ç‰‡å³ä¸Šè§’çš„â€œx5â€å¼€å…³åï¼Œåœ¨ç”»å¸ƒè½»è§¦ä½ç½®æ‰¹é‡æ”¾ç½®ã€‚</div>
                <div class="component-strip">

                <!-- ç£·è„‚åˆ†å­ï¼ˆæ­£ç½®ï¼‰ -->
                <div class="component-item" draggable="true" data-type="phospholipid-up" data-name="ç£·è„‚åˆ†å­ï¼ˆæ­£ç½®ï¼‰" title="ç£·è„‚åˆ†å­ï¼ˆæ­£ç½®ï¼‰ï¼šå¤´éƒ¨æœå¤–ã€å°¾éƒ¨æœå†…">
                    <button class="bulk-chip" data-type="phospholipid-up" title="æ‰¹é‡æ”¾ç½®5ä¸ªï¼ˆæ­£ç½®ï¼‰">x5</button>
                    <div class="component-visual">
                        <svg width="80" height="60" viewBox="0 0 80 60">
                            <circle cx="20" cy="15" r="8" fill="#64B5F6"/>
                            <path d="M15 25 C 12 32, 18 38, 15 45 C 12 50, 18 55, 15 58" stroke="#EF5350" stroke-width="2.5" fill="none"/>
                            <path d="M25 25 C 28 32, 22 38, 25 45 C 28 50, 22 55, 25 58" stroke="#EF5350" stroke-width="2.5" fill="none"/>

                            <circle cx="60" cy="15" r="8" fill="#64B5F6"/>
                            <path d="M55 25 C 52 32, 58 38, 55 45 C 52 50, 58 55, 55 58" stroke="#EF5350" stroke-width="2.5" fill="none"/>
                            <path d="M65 25 C 68 32, 62 38, 65 45 C 68 50, 62 55, 65 58" stroke="#EF5350" stroke-width="2.5" fill="none"/>
                        </svg>
                    </div>
                    <div class="component-name">ç£·è„‚(æ­£)</div>
                    <div class="component-desc">å¤´éƒ¨æœå¤–ã€å°¾éƒ¨æœå†…ï¼Œæ„æˆä¸Šå±‚</div>
                </div>

                <!-- ç£·è„‚åˆ†å­ï¼ˆå€’ç½®ï¼‰ -->
                <div class="component-item" draggable="true" data-type="phospholipid-down" data-name="ç£·è„‚åˆ†å­ï¼ˆå€’ç½®ï¼‰" title="ç£·è„‚åˆ†å­ï¼ˆå€’ç½®ï¼‰ï¼šå¤´éƒ¨æœå¤–ã€å°¾éƒ¨æœå†…ï¼ˆä¸‹å±‚ï¼‰">
                    <button class="bulk-chip" data-type="phospholipid-down" title="æ‰¹é‡æ”¾ç½®5ä¸ªï¼ˆå€’ç½®ï¼‰">x5</button>
                    <div class="component-visual">
                        <svg width="80" height="60" viewBox="0 0 80 60">
                            <circle cx="20" cy="45" r="8" fill="#64B5F6"/>
                            <path d="M15 35 C 12 28, 18 22, 15 15 C 12 10, 18 5, 15 2" stroke="#EF5350" stroke-width="2.5" fill="none"/>
                            <path d="M25 35 C 28 28, 22 22, 25 15 C 28 10, 22 5, 25 2" stroke="#EF5350" stroke-width="2.5" fill="none"/>

                            <circle cx="60" cy="45" r="8" fill="#64B5F6"/>
                            <path d="M55 35 C 52 28, 58 22, 55 15 C 52 10, 58 5, 55 2" stroke="#EF5350" stroke-width="2.5" fill="none"/>
                            <path d="M65 35 C 68 28, 62 22, 65 15 C 68 10, 62 5, 65 2" stroke="#EF5350" stroke-width="2.5" fill="none"/>
                        </svg>
                    </div>
                    <div class="component-name">ç£·è„‚(å€’)</div>
                    <div class="component-desc">å¤´éƒ¨æœå¤–ã€å°¾éƒ¨æœå†…ï¼Œæ„æˆä¸‹å±‚</div>
                </div>

                <div class="component-item" draggable="true" data-type="integral-protein" data-name="è·¨è†œè›‹ç™½" title="è·¨è†œè›‹ç™½ï¼šåµŒå…¥å¹¶ç©¿è¿‡è„‚åŒå±‚">
                    <div class="component-visual">
                        <svg width="80" height="60" viewBox="0 0 80 60">
                            <path d="M28 8 C 24 18, 24 42, 28 52 L52 52 C 56 42, 56 18, 52 8 Z" fill="#9575CD" opacity="0.95"/>
                        </svg>
                    </div>
                    <div class="component-name">è·¨è†œè›‹ç™½</div>
                    <div class="component-desc">è´¯ç©¿æ•´ä¸ªè„‚åŒå±‚ï¼Œå‚ä¸ç‰©è´¨è¿è¾“å’Œä¿¡å·ä¼ å¯¼</div>
                </div>

                <div class="component-item" draggable="true" data-type="peripheral-protein" data-name="å¤–å‘¨è›‹ç™½" title="å¤–å‘¨è›‹ç™½ï¼šé™„ç€è†œå†…å¤–è¡¨é¢ï¼Œä¸ç©¿è¿‡è†œ">
                    <div class="component-visual">
                        <svg width="80" height="60" viewBox="0 0 80 60">
                            <ellipse cx="40" cy="30" rx="24" ry="14" fill="#B39DDB" opacity="0.95"/>
                        </svg>
                    </div>
                    <div class="component-name">å¤–å‘¨è›‹ç™½</div>
                    <div class="component-desc">é™„ç€åœ¨è†œçš„å†…å¤–è¡¨é¢ï¼Œä¸ç©¿è¿‡è„‚åŒå±‚</div>
                </div>

                <div class="component-item" draggable="true" data-type="glycoprotein" data-name="ç³–è›‹ç™½" title="ç³–è›‹ç™½ï¼šä¸»é“¾å‘ä¸Š + å³ä¾§é•¿æ”¯é“¾ï¼Œå…­è¾¹å½¢ç³–ç›¸è¿ï¼Œæ— è¿çº¿">
                    <div class="component-visual">
                        <svg width="80" height="60" viewBox="0 0 80 60">
                            <rect x="30" y="28" width="20" height="27" rx="6" fill="#7CB342" opacity="0.9"/>
                            <!-- ä¸»é“¾ä¸Šçš„å…­è¾¹å½¢ç³–ï¼ˆç›¸é‚»æ’åˆ—ï¼Œæ— è¿çº¿ï¼‰ -->
                            <polygon points="43,24 41.5,21.4 38.5,21.4 37,24 38.5,26.6 41.5,26.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="43,18 41.5,15.4 38.5,15.4 37,18 38.5,20.6 41.5,20.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="43,12 41.5,9.4 38.5,9.4 37,12 38.5,14.6 41.5,14.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="43,6 41.5,3.4 38.5,3.4 37,6 38.5,8.6 41.5,8.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <!-- å³ä¾§æ”¯é“¾ä¸Šçš„ 6 ä¸ªå…­è¾¹å½¢ç³–ï¼ˆæ²¿æ–œå‘æ’åˆ—ï¼Œæ— è¿çº¿ï¼‰ -->
                            <polygon points="49,20.5 47.5,17.9 44.5,17.9 43,20.5 44.5,23.1 47.5,23.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="53,18.5 51.5,15.9 48.5,15.9 47,18.5 48.5,21.1 51.5,21.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="57,16.5 55.5,13.9 52.5,13.9 51,16.5 52.5,19.1 55.5,19.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="61,14.5 59.5,11.9 56.5,11.9 55,14.5 56.5,17.1 59.5,17.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="65,12.5 63.5,9.9 60.5,9.9 59,12.5 60.5,15.1 63.5,15.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="69,10.5 67.5,7.9 64.5,7.9 63,10.5 64.5,13.1 67.5,13.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="73,8.5 71.5,5.9 68.5,5.9 67,8.5 68.5,11.1 71.5,11.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="77,6.5 75.5,3.9 72.5,3.9 71,6.5 72.5,9.1 75.5,9.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                        </svg>
                    </div>
                    <div class="component-name">ç³–è›‹ç™½</div>
                    <div class="component-desc">ä¸€æ¡ä¸»é“¾ + å³ä¾§è¾ƒé•¿æ”¯é“¾ï¼ˆâ‰¥6 å…­è¾¹å½¢ç³–ï¼‰</div>
                </div>

                <div class="component-item" draggable="true" data-type="glycolipid" data-name="ç³–è„‚" title="ç³–è„‚ï¼šä¸»é“¾ä¸Šå»¶ + å³ä¾§é•¿æ”¯é“¾ï¼Œå…­è¾¹å½¢ç³–ç›¸è¿ï¼Œæ— è¿çº¿">
                    <div class="component-visual">
                        <svg width="80" height="60" viewBox="0 0 80 60">
                            <!-- æ©™çº¢è‰²ç–æ°´å°¾ï¼ˆæ³¢æµªï¼‰ + å¤´éƒ¨ -->
                            <circle cx="40" cy="35" r="6" fill="#FF7043"/>
                            <path d="M35 41 C 32 46, 38 50, 35 54" stroke="#EF5350" stroke-width="2.5" fill="none"/>
                            <path d="M45 41 C 48 46, 42 50, 45 54" stroke="#EF5350" stroke-width="2.5" fill="none"/>
                            <!-- ä¸»é“¾ä¸Šçš„å…­è¾¹å½¢ç³–ï¼ˆç›¸é‚»æ’åˆ—ï¼‰ -->
                            <polygon points="43,25 41.5,22.4 38.5,22.4 37,25 38.5,27.6 41.5,27.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="43,19 41.5,16.4 38.5,16.4 37,19 38.5,21.6 41.5,21.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="43,13.5 41.5,10.9 38.5,10.9 37,13.5 38.5,16.1 41.5,16.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <!-- å³ä¾§æ”¯é“¾ä¸Šçš„ 6 ä¸ªå…­è¾¹å½¢ç³–ï¼ˆæ–œå‘æ’åˆ—ï¼‰ -->
                            <polygon points="49,21 47.5,18.4 44.5,18.4 43,21 44.5,23.6 47.5,23.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="53,19 51.5,16.4 48.5,16.4 47,19 48.5,21.6 51.5,21.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="57,17 55.5,14.4 52.5,14.4 51,17 52.5,19.6 55.5,19.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="61,15 59.5,12.4 56.5,12.4 55,15 56.5,17.6 59.5,17.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="65,13 63.5,10.4 60.5,10.4 59,13 60.5,15.6 63.5,15.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="69,11 67.5,8.4 64.5,8.4 63,11 64.5,13.6 67.5,13.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="73,9 71.5,6.4 68.5,6.4 67,9 68.5,11.6 71.5,11.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                            <polygon points="77,7 75.5,4.4 72.5,4.4 71,7 72.5,9.6 75.5,9.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                        </svg>
                    </div>
                    <div class="component-name">ç³–è„‚</div>
                    <div class="component-desc">ä¸€æ¡ä¸»é“¾ + å³ä¾§è¾ƒé•¿æ”¯é“¾ï¼ˆâ‰¥6 å…­è¾¹å½¢ç³–ï¼‰</div>
                </div>

                <div class="component-item" draggable="true" data-type="cholesterol" data-name="èƒ†å›ºé†‡" title="èƒ†å›ºé†‡ï¼šä½äºè„‚åŒå±‚ä¸­ï¼Œè°ƒèŠ‚æµåŠ¨æ€§">
                    <div class="component-visual">
                        <svg width="80" height="60" viewBox="0 0 80 60">
                            <!-- è¾ƒå°çš„åˆšæ€§ç¯çŠ¶ç»“æ„ï¼ˆé»„è‰²ï¼‰ -->
                            <polygon points="40,18 48,24 48,36 40,42 32,36 32,24" fill="#FFB300" opacity="0.95"/>
                            <circle cx="40" cy="30" r="4.5" fill="#F57C00"/>
                        </svg>
                    </div>
                    <div class="component-name">èƒ†å›ºé†‡</div>
                    <div class="component-desc">è°ƒèŠ‚è†œçš„æµåŠ¨æ€§å’Œç¨³å®šæ€§</div>
                </div>

                <div class="component-item" draggable="true" data-type="channel-protein" data-name="é€šé“è›‹ç™½" title="ç¦»å­é€šé“ï¼šå½¢æˆè´¯ç©¿é¦–å°¾çš„äº²æ°´é€šé“">
                    <div class="component-visual">
                        <svg width="80" height="60" viewBox="0 0 80 60">
                            <!-- è´¯ç©¿å‹é€šé“ï¼šå†…å­”é•‚ç©ºï¼ˆé€æ˜ï¼‰ï¼Œä»é¡¶éƒ¨åˆ°åº•éƒ¨è´¯ç©¿ -->
                            <defs>
                                <mask id="channelMaskIcon">
                                    <rect x="0" y="0" width="80" height="60" fill="white"/>
                                    <!-- é»‘è‰²åŒºåŸŸä¸ºé•‚ç©ºå†…å­”ï¼ˆé¦–å°¾è´¯ç©¿ï¼‰ -->
                                    <rect x="34" y="0" width="12" height="60" rx="6" fill="black"/>
                                </mask>
                            </defs>
                            <rect x="28" y="6" width="24" height="48" rx="10" fill="#9575CD" opacity="0.95" mask="url(#channelMaskIcon)"/>
                        </svg>
                    </div>
                    <div class="component-name">é€šé“è›‹ç™½</div>
                    <div class="component-desc">å½¢æˆäº²æ°´é€šé“ï¼Œå…è®¸ç‰¹å®šç¦»å­é€šè¿‡</div>
                </div>

                <div class="component-item" draggable="true" data-type="carrier-protein" data-name="è½½ä½“è›‹ç™½" title="è½½ä½“è›‹ç™½ï¼šé¦–å°¾è´¯ç©¿ï¼Œå·¦å³å‡¹æ§½ï¼Œæ›´åšå®ï¼›é€šé“æ›´çª„">
                    <div class="component-visual">
                        <svg width="80" height="60" viewBox="0 0 80 60">
                            <defs>
                                <mask id="carrierMaskIcon">
                                    <rect x="0" y="0" width="80" height="60" fill="white"/>
                                    <!-- é¦–å°¾è´¯ç©¿çš„å†…å­” -->
                                    <rect x="36" y="0" width="8" height="60" rx="4" fill="black"/>
                                    <!-- å·¦å³ä¸¤ä¾§åŠåœ†å½¢å‡¹æ§½/ç¼ºå£ -->
                                    <circle cx="36" cy="30" r="4.5" fill="black"/>
                                    <circle cx="44" cy="30" r="4.5" fill="black"/>
                                </mask>
                            </defs>
                            <!-- å¤–éƒ¨ä¸»ä½“æ›´åšå®ï¼ˆå¢å®½ï¼‰ + é•‚ç©ºå†…å­” -->
                            <rect x="25" y="6" width="30" height="48" rx="12" fill="#7E57C2" opacity="0.95" mask="url(#carrierMaskIcon)"/>
                        </svg>
                    </div>
                    <div class="component-name">è½½ä½“è›‹ç™½</div>
                    <div class="component-desc">é¦–å°¾è´¯ç©¿ï¼Œå·¦å³ä¾§å£å‡æœ‰å‡¹æ§½/ç¼ºå£</div>
                </div>

                <!-- æ–°å¢ï¼šå¤šç³–é“¾ï¼ˆå…­è¾¹å½¢ç›¸è¿ï¼Œæ— è¿çº¿ï¼‰ -->
                <div class="component-item" draggable="true" data-type="polysaccharide" data-name="å¤šç³–é“¾" title="å¤šç³–é“¾ï¼šå…­è¾¹å½¢ç³–ç›¸è¿ï¼Œä¸»é“¾æ›´é•¿ï¼Œå³ä¾§æœ‰è¾ƒé•¿æ”¯é“¾">
                    <div class="component-visual">
                        <svg width="80" height="60" viewBox="0 0 80 60">
                <!-- ä¸»é“¾ï¼šçºµå‘ 5 ä¸ªå…­è¾¹å½¢ -->
                <polygon points="43,48 41.5,45.4 38.5,45.4 37,48 38.5,50.6 41.5,50.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="43,42 41.5,39.4 38.5,39.4 37,42 38.5,44.6 41.5,44.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="43,36 41.5,33.4 38.5,33.4 37,36 38.5,38.6 41.5,38.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="43,30 41.5,27.4 38.5,27.4 37,30 38.5,32.6 41.5,32.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="43,24 41.5,21.4 38.5,21.4 37,24 38.5,26.6 41.5,26.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="43,18 41.5,15.4 38.5,15.4 37,18 38.5,20.6 41.5,20.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <!-- å³ä¾§è¾ƒé•¿æ”¯é“¾ï¼šâ‰¥6 ä¸ªå…­è¾¹å½¢ï¼Œæ–œå‘æ’åˆ— -->
                <polygon points="49,44.5 47.5,41.9 44.5,41.9 43,44.5 44.5,47.1 47.5,47.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="53,42.5 51.5,39.9 48.5,39.9 47,42.5 48.5,45.1 51.5,45.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="57,40.5 55.5,37.9 52.5,37.9 51,40.5 52.5,43.1 55.5,43.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="61,38.5 59.5,35.9 56.5,35.9 55,38.5 56.5,41.1 59.5,41.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="65,36.5 63.5,33.9 60.5,33.9 59,36.5 60.5,39.1 63.5,39.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="69,34.5 67.5,31.9 64.5,31.9 63,34.5 64.5,37.1 67.5,37.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="73,32.5 71.5,29.9 68.5,29.9 67,32.5 68.5,35.1 71.5,35.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="77,30.5 75.5,27.9 72.5,27.9 71,30.5 72.5,33.1 75.5,33.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                        </svg>
                    </div>
                    <div class="component-name">å¤šç³–é“¾</div>
                    <div class="component-desc">å…­è¾¹å½¢ç›¸è¿çš„é•¿é“¾ï¼Œå³ä¾§é•¿æ”¯é“¾</div>
                </div>

                <!-- æ–°å¢ï¼šå¯¡ç³–é“¾ï¼ˆå…­è¾¹å½¢ç›¸è¿ï¼Œæ— è¿çº¿ï¼‰ -->
                <div class="component-item" draggable="true" data-type="oligosaccharide" data-name="å¯¡ç³–é“¾" title="å¯¡ç³–é“¾ï¼šå…­è¾¹å½¢ç³–ç›¸è¿ï¼Œä¸»é“¾è¾ƒçŸ­ï¼Œå³ä¾§çŸ­æ”¯é“¾">
                    <div class="component-visual">
                        <svg width="80" height="60" viewBox="0 0 80 60">
                <!-- ä¸»é“¾ï¼šçºµå‘ 3 ä¸ªå…­è¾¹å½¢ -->
                <polygon points="43,42 41.5,39.4 38.5,39.4 37,42 38.5,44.6 41.5,44.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="43,36 41.5,33.4 38.5,33.4 37,36 38.5,38.6 41.5,38.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="43,30 41.5,27.4 38.5,27.4 37,30 38.5,32.6 41.5,32.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="43,24 41.5,21.4 38.5,21.4 37,24 38.5,26.6 41.5,26.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <!-- å³ä¾§çŸ­æ”¯é“¾ï¼š2-3 ä¸ªå…­è¾¹å½¢ -->
                <polygon points="49,38.5 47.5,35.9 44.5,35.9 43,38.5 44.5,41.1 47.5,41.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="53,36.5 51.5,33.9 48.5,33.9 47,36.5 48.5,39.1 51.5,39.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="57,34.5 55.5,31.9 52.5,31.9 51,34.5 52.5,37.1 55.5,37.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                        </svg>
                    </div>
                    <div class="component-name">å¯¡ç³–é“¾</div>
                    <div class="component-desc">å…­è¾¹å½¢ç›¸è¿çš„çŸ­é“¾ï¼Œå³ä¾§çŸ­æ”¯é“¾</div>
                </div>
                </div> <!-- /.component-strip -->
            </div>

            <div class="membrane-builder">
                <div class="builder-header">
                    <h2>ğŸ”¬ è†œç»“æ„ç»„è£…åŒº</h2>
                    <div class="control-buttons">
                        <button class="btn btn-icon" id="studioBtn" onclick="toggleStudio()">å·¥ä½œå°</button>
                        <button class="btn btn-icon" id="gridBtn" onclick="toggleGrid()">ç½‘æ ¼</button>
                        <button class="btn btn-icon" id="snapBtn" onclick="toggleSnap()">å¸é™„</button>
                        <button class="btn btn-icon" onclick="zoomOut()">ç¼©å°</button>
                        <button class="btn btn-icon" onclick="zoomIn()">æ”¾å¤§</button>
                        <button class="btn btn-icon" onclick="resetView()">é‡ç½®è§†å›¾</button>
                        <button class="btn btn-motion" id="motionToggleBtn" onclick="toggleMotion()">å¼€å¯è¿åŠ¨</button>
                        <button class="btn btn-save" onclick="saveCustomPreset()">ä¿å­˜ä¸ºç¤ºä¾‹</button>
                        <button class="btn btn-load" onclick="loadCustomPreset()">åŠ è½½æˆ‘çš„ç¤ºä¾‹</button>
                        <button class="btn btn-preset" onclick="loadPreset()">åŠ è½½ç¤ºä¾‹</button>
                        <button class="btn btn-clear" onclick="clearCanvas()">æ¸…ç©ºç”»å¸ƒ</button>
                    </div>
                </div>

                <div id="membraneCanvas">
                    <div id="canvasContent">
                        <div class="grid-overlay" id="gridOverlay"></div>
                        <div class="membrane-layer" id="membraneBackground"></div>
                        <div class="canvas-intro" id="canvasIntro">
                            <div class="intro-card">
                                <div class="intro-title">ğŸ“ å¿«é€Ÿä¸Šæ‰‹</div>
                                <ul>
                                    <li>ä»å·¦ä¾§é€‰æ‹©â€œç£·è„‚/è›‹ç™½/ç³–ç±»â€ï¼Œåœ¨ç”»å¸ƒè½»è§¦æ”¾ç½®</li>
                                    <li>æ‹–åŠ¨ç»„ä»¶è°ƒæ•´ä½ç½®ï¼Œå¼€å¯â€œå¸é™„â€æ›´æ•´é½</li>
                                    <li>æ‰“å¼€â€œAI å­¦ä¹ åŠ©æ‰‹â€ï¼Œè·å–è§£é‡Šã€æ ‡æ³¨ä¸ä¼˜åŒ–å»ºè®®</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="resize-handle right" id="resizeRight" title="æ‹–åŠ¨è°ƒæ•´å®½åº¦"></div>
                    <div class="resize-handle bottom" id="resizeBottom" title="æ‹–åŠ¨è°ƒæ•´é«˜åº¦"></div>
                    <div class="resize-handle corner" id="resizeCorner" title="æ‹–åŠ¨è°ƒæ•´å¤§å°"></div>
                </div>
                <div class="status-bar" id="statusBar">
                    <span id="statusPos">X: -ï¼ŒY: -</span>
                    <span id="statusZoom">ç¼©æ”¾: 1.00x</span>
                    <span id="statusFlags">ç½‘æ ¼: å…³ | å¸é™„: å…³</span>
                </div>
            </div>

            <div class="info-panel">
                <div class="ai-launch">
                    <h3>ğŸ¤– AI å­¦ä¹ åŠ©æ‰‹</h3>
                    <p>æ™ºèƒ½é—®ç­”ã€å›¾ç‰‡ç†è§£ä¸å»ºæ¨¡å»ºè®®ï¼Œå¸®åŠ©ä½ æ›´å¿«å®Œæˆä»»åŠ¡ã€‚</p>
                    <ul class="ai-features">
                        <li>æ–‡å­—æé—®ï¼šæ¦‚å¿µè§£é‡Šã€å®éªŒæ€è·¯ã€æ„å‹å»ºè®®</li>
                        <li>å›¾ç‰‡ä¸Šä¼ ï¼šå¯¹æˆªå›¾/ç…§ç‰‡è¿›è¡Œæ ‡æ³¨ä¸è®²è§£</li>
                        <li>ç»“åˆç”»å¸ƒï¼šæ ¹æ®å½“å‰ç»„è£…çŠ¶æ€ç»™å‡ºä¼˜åŒ–å»ºè®®</li>
                    </ul>
                    <button class="ai-btn primary" onclick="openAIModal()">æ‰“å¼€ AI åŠ©æ‰‹</button>
                </div>
                <h2>ğŸ“Š ç»„è£…ç»Ÿè®¡</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">ç£·è„‚ï¼ˆæ­£ç½®ï¼‰</span>
                        <span class="stat-value" id="phospholipidUpCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ç£·è„‚ï¼ˆå€’ç½®ï¼‰</span>
                        <span class="stat-value" id="phospholipidDownCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">è·¨è†œè›‹ç™½</span>
                        <span class="stat-value" id="integralProteinCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å¤–å‘¨è›‹ç™½</span>
                        <span class="stat-value" id="peripheralProteinCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ç³–è›‹ç™½</span>
                        <span class="stat-value" id="glycoproteinCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ç³–è„‚</span>
                        <span class="stat-value" id="glycolipidCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">èƒ†å›ºé†‡</span>
                        <span class="stat-value" id="cholesterolCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">é€šé“è›‹ç™½</span>
                        <span class="stat-value" id="channelProteinCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">è½½ä½“è›‹ç™½</span>
                        <span class="stat-value" id="carrierProteinCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å¤šç³–é“¾</span>
                        <span class="stat-value" id="polysaccharideCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å¯¡ç³–é“¾</span>
                        <span class="stat-value" id="oligosaccharideCount">0</span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <!-- AI æ‚¬æµ®çª— -->
    <div class="ai-backdrop" id="aiBackdrop" onclick="closeAIModal()"></div>
    <div class="ai-modal" id="aiModal" role="dialog" aria-modal="true" aria-labelledby="aiModalTitle">
        <div class="ai-modal-header">
            <div style="display:flex; align-items:center; gap:8px;">
                <button class="ai-back" onclick="closeAIModal()">â† è¿”å›å»ºæ¨¡</button>
                <div class="ai-modal-title" id="aiModalTitle">ğŸ¤– AI å­¦ä¹ åŠ©æ‰‹</div>
            </div>
            <div>
                <button class="ai-close" aria-label="è®¾ç½®" onclick="toggleAISettings()">âš™ï¸</button>
            </div>
        </div>
        <div class="ai-modal-body">
            <div class="chat-log" id="chatLog"></div>
            <div class="chat-input">
                <input type="file" id="aiImage" accept="image/*" style="display:none" />
                <button class="icon-btn" title="ä¸Šä¼ å›¾ç‰‡" onclick="document.getElementById('aiImage').click()">ğŸ–¼ï¸</button>
                <textarea id="aiQuestion" placeholder="è¾“å…¥é—®é¢˜ï¼ŒæŒ‰ Enter å‘é€ï¼ˆæˆ–ç‚¹å‡»å‘é€ï¼‰"></textarea>
                <button class="send-btn" onclick="askAI()">å‘é€</button>
            </div>
                <div class="ai-settings" id="aiSettingsPanel">
                    <div class="ai-row">
                        <select id="aiProvider">
                            <option value="deepseek">DeepSeek</option>
                            <option value="ark">ç«å±±å¼•æ“ Ark</option>
                        </select>
                        <select id="aiModelSelect"></select>
                        <input type="text" id="aiModel" placeholder="è‡ªå®šä¹‰æ¨¡å‹/æ¨ç†ç‚¹ï¼ˆå¦‚ ep-xxxxï¼‰" style="display:none" />
                        <input type="password" id="aiApiKey" placeholder="API å¯†é’¥ï¼ˆä»…éœ€å¡«å†™æ­¤é¡¹å³å¯ä½¿ç”¨ï¼‰" />
                        <button class="ai-btn" onclick="saveAISettings()">ä¿å­˜</button>
                    </div>
                    <div class="ai-status" id="aiStatus">å¯åœ¨ä¸Šæ–¹é€‰æ‹© DeepSeek æˆ–ç«å±± Arkï¼›åªéœ€å¡«å†™å¯¹åº” API å¯†é’¥å³å¯ä½¿ç”¨ï¼ˆé»˜è®¤æ¨¡å‹ï¼šDeepSeek=deepseek-chatï¼ŒArk=doubao-seed-1-6-250615ï¼‰ã€‚</div>
                </div>
            </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        const canvas = document.getElementById('membraneCanvas');
        const content = document.getElementById('canvasContent');
        const gridOverlay = document.getElementById('gridOverlay');
        const statusBar = document.getElementById('statusBar');
        const statusPos = document.getElementById('statusPos');
        const statusZoom = document.getElementById('statusZoom');
        const statusFlags = document.getElementById('statusFlags');
        const tooltip = document.getElementById('tooltip');
        let draggedElement = null;
        let currentView = 'side'; // 'side' æˆ– 'top'
        let componentCounts = {};
        let selectedType = null; // å½“å‰ç‚¹å‡»æ”¾ç½®é€‰æ‹©çš„ç»„ä»¶ç±»å‹
        let selectedItemEl = null; // å·¦ä¾§è¢«é€‰ä¸­çš„é¡¹
        // è®°å½•ä¸¤ç±»ç£·è„‚å„è‡ªçš„è¡Œï¼ˆä¸­å¿ƒ Yï¼‰ï¼Œç”¨äºå¸é™„æ—¶è‡ªåŠ¨ä¿æŒåŒä¸€æ°´å¹³çº¿
        const lastPhosRowY = { 'phospholipid-up': null, 'phospholipid-down': null };
        // æ‰¹é‡æ”¾ç½®ï¼ˆä¸€æ¬¡æ€§æ·»åŠ 5ä¸ªç£·è„‚ï¼‰
        let bulkPreferredType = null; // 'phospholipid-up' | 'phospholipid-down' | null
        let placeBulkCount = 1; // 1(é»˜è®¤) æˆ– 10
        let motionEnabled = false; // åˆ†å­è¿åŠ¨å¼€å…³ï¼Œé»˜è®¤é™æ­¢

        // ç”»å¸ƒæ‰‹åŠ¨å°ºå¯¸è°ƒèŠ‚
        const resizeHandles = {
            right: null,
            bottom: null,
            corner: null,
        };

        // ç»„ä»¶ä¿¡æ¯å®šä¹‰
        const componentInfo = {
            'phospholipid-up': { name: 'ç£·è„‚åˆ†å­ï¼ˆæ­£ç½®ï¼‰', desc: 'å¤´éƒ¨æœå¤–ã€å°¾éƒ¨æœå†…ï¼Œé€‚ç”¨äºä¸Šå±‚' },
            'phospholipid-down': { name: 'ç£·è„‚åˆ†å­ï¼ˆå€’ç½®ï¼‰', desc: 'å¤´éƒ¨æœå¤–ã€å°¾éƒ¨æœå†…ï¼Œé€‚ç”¨äºä¸‹å±‚' },
            'integral-protein': { name: 'è·¨è†œè›‹ç™½ï¼ˆæ•´åˆè›‹ç™½ï¼‰', desc: 'è´¯ç©¿è„‚åŒå±‚ï¼Œå‚ä¸ç‰©è´¨è¿è¾“å’Œä¿¡å·ä¼ å¯¼' },
            'peripheral-protein': { name: 'å¤–å‘¨è›‹ç™½ï¼ˆè†œå‘¨è›‹ç™½ï¼‰', desc: 'é™„ç€åœ¨è†œçš„å†…å¤–è¡¨é¢ï¼Œä¸ç©¿è¿‡è„‚åŒå±‚' },
            'glycoprotein': { name: 'ç³–è›‹ç™½', desc: 'è›‹ç™½è´¨è¿æ¥ç³–é“¾ï¼Œå‚ä¸ç»†èƒè¯†åˆ«ä¸å…ç–«' },
            'glycolipid': { name: 'ç³–è„‚', desc: 'è„‚è´¨è¿æ¥ç³–é“¾ï¼Œä½äºç»†èƒè†œå¤–ä¾§' },
            'cholesterol': { name: 'èƒ†å›ºé†‡', desc: 'æ’å…¥è„‚åŒå±‚ä¹‹é—´ï¼Œè°ƒèŠ‚è†œçš„æµåŠ¨æ€§ä¸ç¨³å®šæ€§' },
            'channel-protein': { name: 'ç¦»å­é€šé“è›‹ç™½', desc: 'å½¢æˆäº²æ°´å­”é“ï¼Œå…è®¸ç‰¹å®šç¦»å­é€‰æ‹©æ€§é€šè¿‡' },
            'carrier-protein': { name: 'è½½ä½“è›‹ç™½', desc: 'é¦–å°¾è´¯ç©¿ï¼Œå¹¶åœ¨é€šé“å†…å…·æœ‰ç»“åˆä½ç‚¹' },
            'polysaccharide': { name: 'å¤šç³–é“¾', desc: 'è¾ƒé•¿çš„åˆ†æ”¯ç³–é“¾ï¼Œæ„æˆç³–è¼ï¼Œä½äºå¤–ä¾§' },
            'oligosaccharide': { name: 'å¯¡ç³–é“¾', desc: 'è¾ƒçŸ­çš„åˆ†æ”¯ç³–é“¾ï¼Œå¤šè¿æ¥äºç³–è›‹ç™½/ç³–è„‚' }
        };

        // ç»Ÿè®¡é¢æ¿æ˜ å°„
        const typeToCounterId = {
            'phospholipid-up': 'phospholipidUpCount',
            'phospholipid-down': 'phospholipidDownCount',
            'integral-protein': 'integralProteinCount',
            'peripheral-protein': 'peripheralProteinCount',
            'glycoprotein': 'glycoproteinCount',
            'glycolipid': 'glycolipidCount',
            'cholesterol': 'cholesterolCount',
            'channel-protein': 'channelProteinCount',
            'carrier-protein': 'carrierProteinCount',
            'polysaccharide': 'polysaccharideCount',
            'oligosaccharide': 'oligosaccharideCount'
        };

        // æœ¬åœ°å­˜å‚¨é”®å
        const STORAGE_KEY = 'cell-membrane-custom-preset-v1';
        const AI_SETTINGS_KEY = 'cell-membrane-ai-settings-v1';
        const ARK_ENDPOINT_DEFAULT = 'https://ark.cn-beijing.volces.com/api/v3/chat/completions';
        const DEEPSEEK_ENDPOINT_DEFAULT = 'https://api.deepseek.com/chat/completions';

        // ç»„ä»¶SVGå®šä¹‰ï¼ˆæ›´è¯¦ç»†ç‰ˆæœ¬ï¼‰
        const componentSVGs = {
            'phospholipid-up': `<svg width="40" height="80" viewBox="0 0 40 80">
                <circle cx="20" cy="14" r="10" fill="#64B5F6" opacity="0.95"/>
                <path d="M15 26 C 12 36, 18 44, 15 52 C 12 58, 18 66, 15 72" stroke="#EF5350" stroke-width="3" fill="none"/>
                <path d="M25 26 C 28 36, 22 44, 25 52 C 28 58, 22 66, 25 72" stroke="#EF5350" stroke-width="3" fill="none"/>
            </svg>`,
            'phospholipid-down': `<svg width="40" height="80" viewBox="0 0 40 80">
                <circle cx="20" cy="66" r="10" fill="#64B5F6" opacity="0.95"/>
                <path d="M15 56 C 12 46, 18 38, 15 30 C 12 24, 18 16, 15 10" stroke="#EF5350" stroke-width="3" fill="none"/>
                <path d="M25 56 C 28 46, 22 38, 25 30 C 28 24, 22 16, 25 10" stroke="#EF5350" stroke-width="3" fill="none"/>
            </svg>`,

            'integral-protein': `<svg width="60" height="200" viewBox="0 0 60 200">
                <path d="M15 24 C 10 60, 10 140, 15 176 L45 176 C 50 140, 50 60, 45 24 Z" fill="#9575CD" opacity="0.95"/>
            </svg>`,

            'peripheral-protein': `<svg width="70" height="50" viewBox="0 0 70 50">
                <ellipse cx="35" cy="25" rx="28" ry="18" fill="#B39DDB" opacity="0.95"/>
            </svg>`,

            'glycoprotein': `<svg width="80" height="60" viewBox="0 0 80 60">
                <rect x="30" y="28" width="20" height="27" rx="6" fill="#7CB342" opacity="0.9"/>
                <!-- ä¸»é“¾å…­è¾¹å½¢ï¼ˆç›¸é‚»æ’åˆ—ï¼Œæ— è¿çº¿ï¼‰ -->
                <polygon points="43,24 41.5,21.4 38.5,21.4 37,24 38.5,26.6 41.5,26.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="43,18 41.5,15.4 38.5,15.4 37,18 38.5,20.6 41.5,20.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="43,12 41.5,9.4 38.5,9.4 37,12 38.5,14.6 41.5,14.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="43,6 41.5,3.4 38.5,3.4 37,6 38.5,8.6 41.5,8.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <!-- å³ä¾§æ”¯é“¾å…­è¾¹å½¢ï¼ˆâ‰¥6 ä¸ªï¼‰ -->
                <polygon points="49,20.5 47.5,17.9 44.5,17.9 43,20.5 44.5,23.1 47.5,23.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="53,18.5 51.5,15.9 48.5,15.9 47,18.5 48.5,21.1 51.5,21.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="57,16.5 55.5,13.9 52.5,13.9 51,16.5 52.5,19.1 55.5,19.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="61,14.5 59.5,11.9 56.5,11.9 55,14.5 56.5,17.1 59.5,17.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="65,12.5 63.5,9.9 60.5,9.9 59,12.5 60.5,15.1 63.5,15.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="69,10.5 67.5,7.9 64.5,7.9 63,10.5 64.5,13.1 67.5,13.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="73,8.5 71.5,5.9 68.5,5.9 67,8.5 68.5,11.1 71.5,11.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="77,6.5 75.5,3.9 72.5,3.9 71,6.5 72.5,9.1 75.5,9.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
            </svg>`,

            'glycolipid': `<svg width="80" height="60" viewBox="0 0 80 60">
                <!-- å¤´éƒ¨ä¸ä¸¤æ¡ç–æ°´å°¾ï¼ˆæ³¢æµªï¼‰ -->
                <circle cx="40" cy="35" r="6" fill="#FF7043"/>
                <path d="M35 41 C 32 46, 38 50, 35 54" stroke="#EF5350" stroke-width="2.5" fill="none"/>
                <path d="M45 41 C 48 46, 42 50, 45 54" stroke="#EF5350" stroke-width="2.5" fill="none"/>
                <!-- ä¸»é“¾å…­è¾¹å½¢ï¼ˆç›¸é‚»æ’åˆ—ï¼‰ -->
                <polygon points="43,25 41.5,22.4 38.5,22.4 37,25 38.5,27.6 41.5,27.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="43,19 41.5,16.4 38.5,16.4 37,19 38.5,21.6 41.5,21.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="43,13.5 41.5,10.9 38.5,10.9 37,13.5 38.5,16.1 41.5,16.1" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <!-- å³ä¾§æ”¯é“¾å…­è¾¹å½¢ï¼ˆâ‰¥6 ä¸ªï¼‰ -->
                <polygon points="49,21 47.5,18.4 44.5,18.4 43,21 44.5,23.6 47.5,23.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="53,19 51.5,16.4 48.5,16.4 47,19 48.5,21.6 51.5,21.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="57,17 55.5,14.4 52.5,14.4 51,17 52.5,19.6 55.5,19.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="61,15 59.5,12.4 56.5,12.4 55,15 56.5,17.6 59.5,17.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="65,13 63.5,10.4 60.5,10.4 59,13 60.5,15.6 63.5,15.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="69,11 67.5,8.4 64.5,8.4 63,11 64.5,13.6 67.5,13.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="73,9 71.5,6.4 68.5,6.4 67,9 68.5,11.6 71.5,11.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
                <polygon points="77,7 75.5,4.4 72.5,4.4 71,7 72.5,9.6 75.5,9.6" fill="#FFD54F" stroke="#FFA000" stroke-width="0.9"/>
            </svg>`,

            'cholesterol': `<svg width="45" height="60" viewBox="0 0 45 60">
                <polygon points="22.5,12 34,20 34,40 22.5,48 11,40 11,20" fill="#FFB300" opacity="0.95"/>
                <circle cx="22.5" cy="30" r="6" fill="#F57C00"/>
            </svg>`,

            'channel-protein': `<svg width="60" height="200" viewBox="0 0 60 200">
                <!-- è´¯ç©¿å­”é“ä½¿ç”¨é®ç½©å®ç°é•‚ç©ºæ•ˆæœ -->
                <defs>
                    <mask id="channelMaskPlaced">
                        <rect x="0" y="0" width="60" height="200" fill="white"/>
                        <!-- é»‘è‰²åŒºåŸŸä¸ºé•‚ç©ºé€šé“ï¼ˆé¦–å°¾è´¯ç©¿ï¼‰ -->
                        <rect x="22" y="0" width="16" height="200" rx="8" fill="black"/>
                    </mask>
                </defs>
                <rect x="15" y="10" width="30" height="180" rx="14" fill="#9575CD" opacity="0.95" mask="url(#channelMaskPlaced)"/>
            </svg>`,

            'carrier-protein': `<svg width="60" height="200" viewBox="0 0 60 200">
                <!-- é¦–å°¾è´¯ç©¿çš„è½½ä½“è›‹ç™½ï¼šå¤–éƒ¨ä¸»ä½“æ›´åšå® + æ›´çª„çš„é•‚ç©ºé€šé“ + å·¦å³å‡¹æ§½ç»“åˆä½ç‚¹ -->
                <defs>
                    <mask id="carrierMaskPlaced">
                        <rect x="0" y="0" width="60" height="200" fill="white"/>
                        <!-- æ›´çª„çš„è´¯ç©¿é€šé“ï¼ˆå±…ä¸­ï¼‰ -->
                        <rect x="25" y="0" width="10" height="200" rx="6" fill="black"/>
                        <!-- å·¦å³ä¾§å£å„ä¸€ä¸ªåŠåœ†å‡¹æ§½ä½œä¸ºç»“åˆä½ç‚¹ï¼ˆè´´è¿‘é€šé“ï¼‰ -->
                        <circle cx="25" cy="100" r="6.5" fill="black"/>
                        <circle cx="35" cy="100" r="6.5" fill="black"/>
                    </mask>
                </defs>
                <!-- å¤–éƒ¨ä¸»ä½“æ›´åšå®ï¼ˆå¢å®½ï¼‰ -->
                <rect x="12" y="10" width="36" height="180" rx="16" fill="#7E57C2" opacity="0.95" mask="url(#carrierMaskPlaced)"/>
            </svg>`,
            'polysaccharide': `<svg width="80" height="120" viewBox="0 0 80 120">
                <!-- ä¸»é“¾ï¼šçºµå‘å…­è¾¹å½¢ï¼ˆæ›´é•¿ï¼‰ -->
                <polygon points="43,100 41.5,97.4 38.5,97.4 37,100 38.5,102.6 41.5,102.6" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
                <polygon points="43,92 41.5,89.4 38.5,89.4 37,92 38.5,94.6 41.5,94.6" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
                <polygon points="43,84 41.5,81.4 38.5,81.4 37,84 38.5,86.6 41.5,86.6" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
                <polygon points="43,76 41.5,73.4 38.5,73.4 37,76 38.5,78.6 41.5,78.6" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
                <polygon points="43,68 41.5,65.4 38.5,65.4 37,68 38.5,70.6 41.5,70.6" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
                <polygon points="43,60 41.5,57.4 38.5,57.4 37,60 38.5,62.6 41.5,62.6" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
                <polygon points="43,52 41.5,49.4 38.5,49.4 37,52 38.5,54.6 41.5,54.6" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
                <!-- å³ä¾§è¾ƒé•¿æ”¯é“¾ï¼šâ‰¥6 ä¸ªå…­è¾¹å½¢ï¼Œæ–œå‘æ’åˆ— -->
                <polygon points="49,96.5 47.5,93.9 44.5,93.9 43,96.5 44.5,99.1 47.5,99.1" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
                <polygon points="53,94.5 51.5,91.9 48.5,91.9 47,94.5 48.5,97.1 51.5,97.1" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
                <polygon points="57,92.5 55.5,89.9 52.5,89.9 51,92.5 52.5,95.1 55.5,95.1" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
                <polygon points="61,90.5 59.5,87.9 56.5,87.9 55,90.5 56.5,93.1 59.5,93.1" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
                <polygon points="65,88.5 63.5,85.9 60.5,85.9 59,88.5 60.5,91.1 63.5,91.1" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
                <polygon points="69,86.5 67.5,83.9 64.5,83.9 63,86.5 64.5,89.1 67.5,89.1" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
                <polygon points="73,84.5 71.5,81.9 68.5,81.9 67,84.5 68.5,87.1 71.5,87.1" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
                <polygon points="77,82.5 75.5,79.9 72.5,79.9 71,82.5 72.5,85.1 75.5,85.1" fill="#FFD54F" stroke="#FFA000" stroke-width="1.2"/>
            </svg>`,
            'oligosaccharide': `<svg width="80" height="100" viewBox="0 0 80 100">
                <!-- ä¸»é“¾ï¼šçºµå‘è¾ƒçŸ­ï¼ˆ3 ä¸ªï¼‰ -->
                <polygon points="43,72 41.5,69.4 38.5,69.4 37,72 38.5,74.6 41.5,74.6" fill="#FFD54F" stroke="#FFA000" stroke-width="1.1"/>
                <polygon points="43,64 41.5,61.4 38.5,61.4 37,64 38.5,66.6 41.5,66.6" fill="#FFD54F" stroke="#FFA000" stroke-width="1.1"/>
                <polygon points="43,56 41.5,53.4 38.5,53.4 37,56 38.5,58.6 41.5,58.6" fill="#FFD54F" stroke="#FFA000" stroke-width="1.1"/>
                <polygon points="43,48 41.5,45.4 38.5,45.4 37,48 38.5,50.6 41.5,50.6" fill="#FFD54F" stroke="#FFA000" stroke-width="1.1"/>
                <!-- å³ä¾§çŸ­æ”¯é“¾ï¼š3 ä¸ªå…­è¾¹å½¢ -->
                <polygon points="49,68.5 47.5,65.9 44.5,65.9 43,68.5 44.5,71.1 47.5,71.1" fill="#FFD54F" stroke="#FFA000" stroke-width="1.1"/>
                <polygon points="53,66.5 51.5,63.9 48.5,63.9 47,66.5 48.5,69.1 51.5,69.1" fill="#FFD54F" stroke="#FFA000" stroke-width="1.1"/>
                <polygon points="57,64.5 55.5,61.9 52.5,61.9 51,64.5 52.5,67.1 55.5,67.1" fill="#FFD54F" stroke="#FFA000" stroke-width="1.1"/>
                <polygon points="61,62.5 59.5,59.9 56.5,59.9 55,62.5 56.5,65.1 59.5,65.1" fill="#FFD54F" stroke="#FFA000" stroke-width="1.1"/>
            </svg>`
        };

        // åˆå§‹åŒ–æ‹–æ‹½ï¼ˆå·¦ä¾§é¢æ¿ -> ç”»å¸ƒï¼‰
        document.querySelectorAll('.component-item').forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragend', handleDragEnd);
            item.addEventListener('click', () => selectItemForPlace(item));
            // è§¦æ§è®¾å¤‡ï¼šè½»è§¦é€‰æ‹©
            if (window.PointerEvent) {
                item.addEventListener('pointerdown', (e) => {
                    if (e.pointerType !== 'mouse') selectItemForPlace(item);
                });
            } else {
                item.addEventListener('touchstart', () => selectItemForPlace(item), { passive: true });
            }
        });

        // å·¦ä¾§ç£·è„‚å¡ç‰‡ä¸Šçš„â€œx5â€èŠ¯ç‰‡äº‹ä»¶ç»‘å®š
        document.querySelectorAll('.bulk-chip').forEach(chip => {
            const type = chip.getAttribute('data-type');
            const handler = (e) => { e.stopPropagation(); toggleBulkPhospho(type); };
            if (window.PointerEvent) chip.addEventListener('pointerdown', handler);
            else chip.addEventListener('click', handler);
        });

        canvas.addEventListener('dragover', handleDragOver);
        canvas.addEventListener('drop', handleDrop);
        canvas.addEventListener('dragleave', handleDragLeave);
        canvas.addEventListener('click', handleCanvasClickToPlace);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') clearSelection(); });
        canvas.addEventListener('mousemove', (e) => {
            const p = screenToContent(e.clientX, e.clientY);
            updateStatus(p);
        });
        // è§¦æ§çŠ¶æ€æ›´æ–°ï¼ˆé¿å…ä¸é¼ æ ‡é‡å¤ï¼‰
        if (window.PointerEvent) {
            canvas.addEventListener('pointermove', (e) => {
                if (e.pointerType === 'mouse') return;
                const p = screenToContent(e.clientX, e.clientY);
                updateStatus(p);
            });
        }

        // è§¦æ§ç‚¹å‡»æ”¾ç½®ï¼ˆé¿å…åŒè§¦å‘ï¼Œä»…å¤„ç† touch/penï¼‰
        if (window.PointerEvent) {
            let downInfo = null;
            canvas.addEventListener('pointerdown', (e) => {
                if (e.pointerType === 'mouse') return;
                downInfo = { x: e.clientX, y: e.clientY, t: Date.now(), target: e.target };
            });
            canvas.addEventListener('pointerup', (e) => {
                if (e.pointerType === 'mouse') return;
                if (!selectedType || !downInfo) return;
                const dt = Date.now() - downInfo.t;
                const dx = Math.abs(e.clientX - downInfo.x);
                const dy = Math.abs(e.clientY - downInfo.y);
                const smallMove = (dx + dy) < 8;
                const validTarget = (downInfo.target === canvas || downInfo.target === content || e.target === canvas || e.target === content);
                if (dt < 400 && smallMove && validTarget) {
                    const p1 = screenToContent(e.clientX, e.clientY);
                    placeAt(selectedType, p1.x, p1.y);
                }
                downInfo = null;
            });
        } else {
            // Touch å…¼å®¹å¤„ç†ï¼ˆæ—§è®¾å¤‡ï¼‰
            let touchDown = null;
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length !== 1) return;
                const t = e.touches[0];
                touchDown = { x: t.clientX, y: t.clientY, time: Date.now(), target: e.target };
            }, { passive: true });
            canvas.addEventListener('touchend', (e) => {
                if (!selectedType || !touchDown) return;
                const dt = Date.now() - touchDown.time;
                if (dt > 400) { touchDown = null; return; }
                const t = (e.changedTouches || [])[0];
                if (!t) { touchDown = null; return; }
                const dx = Math.abs(t.clientX - touchDown.x);
                const dy = Math.abs(t.clientY - touchDown.y);
                const smallMove = (dx + dy) < 8;
                const validTarget = (touchDown.target === canvas || touchDown.target === content);
                if (smallMove && validTarget) {
                    const p1 = screenToContent(t.clientX, t.clientY);
                    placeAt(selectedType, p1.x, p1.y);
                }
                touchDown = null;
            });
        }

        // ç”»å¸ƒç¼©æ”¾ï¼šé»˜è®¤å¯ç”¨è§¦æ§æ‰‹åŠ¿ç¼©æ”¾ï¼Œå¹¶æ ¹æ®è§†å£è‡ªé€‚åº”åˆå§‹ç¼©æ”¾
        const ENABLE_GESTURE_ZOOM = true;
        let zoomScale = 2;
        const MIN_ZOOM = 0.5;
        const MAX_ZOOM = 3;
        let pinchStartDist = 0;
        let pinchStartScale = 2;
        let pinchOrigin = { x: null, y: null };

        // æ ¹æ®æµè§ˆå™¨çª—å£è‡ªåŠ¨ç¼©æ”¾ï¼ˆä»¥ç”»å¸ƒé«˜åº¦ä¸ºåŸºå‡†ï¼‰ï¼Œå¹¶é¿å…ç”¨æˆ·æ‰‹åŠ¨ç¼©æ”¾åè¢«è¦†ç›–
        let lastManualZoomTs = 0;
        function markManualZoom() { lastManualZoomTs = Date.now(); }
        function autoFitToViewport() {
            // ç›®æ ‡ï¼šè®©ç”»å¸ƒå†…å®¹åœ¨ç«–å‘å æ®è§†å£çš„ 60% å·¦å³ï¼Œé¿å…å°å±è¿‡å¤§æˆ–å¤§å±è¿‡å°
            const vh = window.innerHeight || document.documentElement.clientHeight;
            const ch = canvas.clientHeight || 500;
            const target = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, (vh * 0.6) / ch));
            setZoom(target);
        }

        // Studioã€ç½‘æ ¼ã€å¸é™„
        let studioEnabled = false;
        let gridEnabled = false;
        let snapEnabled = false;
        // ä¸ç£·è„‚åˆ†å­å°ºå¯¸ä¿æŒä¸€è‡´ï¼ˆsvg å®½ 40ï¼Œé«˜ 80ï¼‰
        const PHOS_W = 40;
        const PHOS_H = 80;
        const GRID_SIZE = PHOS_W;

        function setZoom(next, originX = null, originY = null) {
            zoomScale = Math.min(MAX_ZOOM, Math.max(MIN_ZOOM, next));
            if (originX != null && originY != null) {
                content.style.transformOrigin = `${originX}px ${originY}px`;
            }
            content.style.transform = `scale(${zoomScale})`;
            updateStatus();
        }

        function distance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.hypot(dx, dy);
        }
        if (ENABLE_GESTURE_ZOOM) {
            canvas.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    pinchStartDist = distance(e.touches);
                    pinchStartScale = zoomScale;
                    // ä»¥åŒæŒ‡ä¸­ç‚¹ä½œä¸ºç¼©æ”¾åŸç‚¹
                    const rect = canvas.getBoundingClientRect();
                    const midX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                    const midY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                    const p = screenToContent(midX, midY);
                    pinchOrigin = { x: p.x, y: p.y };
                }
            }, { passive: false });

            canvas.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const curDist = distance(e.touches);
                    const factor = curDist / pinchStartDist;
                    setZoom(pinchStartScale * factor, pinchOrigin.x, pinchOrigin.y);
                    markManualZoom();
                }
            }, { passive: false });

            canvas.addEventListener('touchend', () => { pinchStartDist = 0; });
            canvas.addEventListener('touchcancel', () => { pinchStartDist = 0; });

            // æ¡Œé¢ï¼šæŒ‰ä½ Ctrl æ»šè½®ç¼©æ”¾ï¼ˆä»¥æŒ‡é’ˆä¸ºä¸­å¿ƒï¼‰
            canvas.addEventListener('wheel', (e) => {
                if (!e.ctrlKey) return;
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const pointerX = (e.clientX - rect.left) / zoomScale;
                const pointerY = (e.clientY - rect.top) / zoomScale;
                const delta = -e.deltaY;
                const factor = Math.exp(delta * 0.0015);
                setZoom(zoomScale * factor, pointerX, pointerY);
                markManualZoom();
            }, { passive: false });
        } else {
            // åˆå§‹è‡ªé€‚åº”
            autoFitToViewport();
        }

        // å§‹ç»ˆåœ¨åŠ è½½åæ‰§è¡Œä¸€æ¬¡è‡ªé€‚åº”ï¼Œä¿è¯åˆå§‹è§†è§‰åˆé€‚
        window.requestAnimationFrame(autoFitToViewport);

        // è¾…åŠ©ï¼šå±å¹•åæ ‡ -> å†…å®¹åæ ‡ï¼ˆè€ƒè™‘ç¼©æ”¾ä¸ä¸­å¿ƒä¸ºåŸç‚¹ï¼‰
        function screenToContent(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            const originX = canvas.clientWidth / 2;
            const originY = canvas.clientHeight / 2;
            const sx = clientX - rect.left;
            const sy = clientY - rect.top;
            const cx = (sx - originX) / zoomScale + originX;
            const cy = (sy - originY) / zoomScale + originY;
            return { x: cx, y: cy };
        }

        // å·¥å…·æ æ“ä½œ
        function toggleStudio() {
            studioEnabled = !studioEnabled;
            document.getElementById('studioBtn')?.classList.toggle('active', studioEnabled);
            canvas.classList.toggle('studio', studioEnabled);
        }
        function toggleGrid() {
            gridEnabled = !gridEnabled;
            document.getElementById('gridBtn')?.classList.toggle('active', gridEnabled);
            gridOverlay.style.display = gridEnabled ? 'block' : 'none';
            updateStatus();
        }
        function toggleSnap() {
            snapEnabled = !snapEnabled;
            document.getElementById('snapBtn')?.classList.toggle('active', snapEnabled);
            updateStatus();
        }
        function zoomIn() { setZoom(Math.min(MAX_ZOOM, zoomScale * 1.15)); markManualZoom(); }
        function zoomOut() { setZoom(Math.max(MIN_ZOOM, zoomScale / 1.15)); markManualZoom(); }
        function resetView() { setZoom(2); markManualZoom(); }

        function updateStatus(pt) {
            if (pt) {
                statusPos.textContent = `X: ${Math.round(pt.x)}ï¼ŒY: ${Math.round(pt.y)}`;
            }
            statusZoom.textContent = `ç¼©æ”¾: ${zoomScale.toFixed(2)}x`;
            statusFlags.textContent = `ç½‘æ ¼: ${gridEnabled ? 'å¼€' : 'å…³'} | å¸é™„: ${snapEnabled ? 'å¼€' : 'å…³'}`;
        }

        // åˆå§‹åŒ–ç”»å¸ƒæ‰‹åŠ¨å°ºå¯¸è°ƒèŠ‚
        function initCanvasManualResize(){
            const right = document.getElementById('resizeRight');
            const bottom = document.getElementById('resizeBottom');
            const corner = document.getElementById('resizeCorner');
            resizeHandles.right = right; resizeHandles.bottom = bottom; resizeHandles.corner = corner;

            const builder = canvas?.parentElement; // .membrane-builder
            if (!canvas || !builder || !right || !bottom || !corner) return;

            const MIN_W = 480;
            const MIN_H = 280;
            function clampCanvas(w,h){
                const maxW = builder.clientWidth - 6; // ç•™å‡ºå†…è¾¹è·è¾¹æ¡†
                const maxH = Math.max(MIN_H, Math.min(window.innerHeight*0.9, 1200));
                return [ Math.max(MIN_W, Math.min(w, maxW)), Math.max(MIN_H, Math.min(h, maxH)) ];
            }
            function attach(handle, mode){
                if (!window.PointerEvent) return; // PC/ç§»åŠ¨å‡æ”¯æŒï¼Œè€è®¾å¤‡ç•¥è¿‡
                handle.addEventListener('pointerdown', (e)=>{
                    e.preventDefault();
                    const rect = canvas.getBoundingClientRect();
                    const startX = e.clientX, startY = e.clientY;
                    const startW = rect.width, startH = rect.height;
                    handle.setPointerCapture?.(e.pointerId);
                    const onMove = (ev)=>{
                        let newW = startW, newH = startH;
                        if (mode==='right' || mode==='corner') newW = startW + (ev.clientX - startX);
                        if (mode==='bottom' || mode==='corner') newH = startH + (ev.clientY - startY);
                        const [cw,ch] = clampCanvas(newW, newH);
                        canvas.style.width = cw + 'px';
                        canvas.style.height = ch + 'px';
                    };
                    const onUp = ()=>{
                        handle.releasePointerCapture?.(e.pointerId);
                        document.removeEventListener('pointermove', onMove);
                        document.removeEventListener('pointerup', onUp);
                        document.removeEventListener('pointercancel', onUp);
                    };
                    document.addEventListener('pointermove', onMove);
                    document.addEventListener('pointerup', onUp);
                    document.addEventListener('pointercancel', onUp);
                });
            }
            attach(right, 'right'); attach(bottom, 'bottom'); attach(corner, 'corner');
        }

        // AI æ‚¬æµ®çª—æ§åˆ¶
        // å°†åŠ©æ‰‹ä»¥â€œæ•´é¡µç•Œé¢â€å‘ˆç°ï¼šéšè—ä¸»ç•Œé¢ï¼Œä»…æ˜¾ç¤ºåŠ©æ‰‹é¡µ
        function openAIModal(){
            const m = document.getElementById('aiModal');
            const b = document.getElementById('aiBackdrop');
            const container = document.querySelector('.container');
            if (!m || !b || !container) return;
            // éšè—ä¸»å®¹å™¨ï¼Œæ‰“å¼€æ•´é¡µåŠ©æ‰‹
            container.classList.add('hidden');
            m.classList.add('page-mode');
            m.style.display = 'flex';
            b.style.display = 'none';
            // ç„¦ç‚¹åˆ°é—®é¢˜è¾“å…¥æ¡†
            setTimeout(()=>{ document.getElementById('aiQuestion')?.focus(); }, 0);
        }
        function closeAIModal(){
            const m = document.getElementById('aiModal');
            const b = document.getElementById('aiBackdrop');
            const container = document.querySelector('.container');
            if (!m || !b || !container) return;
            // æ¢å¤ä¸»å®¹å™¨ï¼Œå…³é—­æ•´é¡µåŠ©æ‰‹
            container.classList.remove('hidden');
            m.classList.remove('page-mode');
            m.style.display = 'none';
            b.style.display = 'none';
        }
        document.addEventListener('keydown', (e)=>{
            if (e.key === 'Escape') closeAIModal();
        });

        function toggleAISettings(){
            const p = document.getElementById('aiSettingsPanel');
            if (!p) return;
            p.style.display = (p.style.display === 'none' || !p.style.display) ? 'block' : 'none';
            if (p.style.display === 'block') refreshModelOptions();
        }

        function appendMessage(role, { text = '', image = null } = {}){
            const log = document.getElementById('chatLog');
            if (!log) return;
            const msg = document.createElement('div');
            msg.className = `msg ${role}`;
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            if (image){
                const img = document.createElement('img');
                img.src = image;
                bubble.appendChild(img);
            }
            if (text){ bubble.appendChild(document.createTextNode(text)); }
            msg.appendChild(bubble);
            log.appendChild(msg);
            log.scrollTop = log.scrollHeight;
        }

        function showTyping(){
            const log = document.getElementById('chatLog');
            const wrap = document.createElement('div');
            wrap.className = 'msg ai';
            wrap.id = 'aiTyping';
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            const dots = document.createElement('div'); dots.className = 'typing';
            dots.innerHTML = '<span></span><span></span><span></span>';
            bubble.appendChild(dots);
            wrap.appendChild(bubble);
            log.appendChild(wrap);
            log.scrollTop = log.scrollHeight;
        }
        function hideTyping(){
            const t = document.getElementById('aiTyping');
            if (t) t.remove();
        }

        // æ¨¡å‹ä¸‹æ‹‰ä¸è‡ªå®šä¹‰è¾“å…¥è”åŠ¨
        const MODEL_OPTIONS = {
            deepseek: ['deepseek-chat', 'deepseek-reasoner', 'è‡ªå®šä¹‰ï¼ˆæ‰‹åŠ¨è¾“å…¥ï¼‰'],
            ark: ['doubao-seed-1-6-250615', 'è‡ªå®šä¹‰ï¼ˆæ‰‹åŠ¨è¾“å…¥ï¼‰']
        };
        function refreshModelOptions(){
            const provider = aiProviderInput()?.value || 'deepseek';
            const sel = aiModelSelect(); const custom = aiModelInput();
            if (!sel) return;
            sel.innerHTML = '';
            (MODEL_OPTIONS[provider] || []).forEach(v => {
                const opt = document.createElement('option'); opt.value = v; opt.textContent = v; sel.appendChild(opt);
            });
            // é»˜è®¤é€‰ç¬¬ä¸€é¡¹
            sel.value = MODEL_OPTIONS[provider]?.[0] || '';
            if (custom) { custom.style.display = sel.value.includes('è‡ªå®šä¹‰') ? 'block' : 'none'; if (!sel.value.includes('è‡ªå®šä¹‰')) custom.value=''; }
        }
        function applyModelToUI(model){
            const provider = aiProviderInput()?.value || 'deepseek';
            const sel = aiModelSelect(); const custom = aiModelInput();
            if (!sel) return;
            const items = MODEL_OPTIONS[provider] || [];
            if (items.includes(model)) { sel.value = model; if (custom) custom.style.display='none'; }
            else { sel.value = 'è‡ªå®šä¹‰ï¼ˆæ‰‹åŠ¨è¾“å…¥ï¼‰'; if (custom) { custom.style.display='block'; custom.value = model; } }
        }
        function readModelFromUI(){
            const sel = aiModelSelect(); const custom = aiModelInput();
            if (!sel) return custom?.value?.trim() || '';
            if (sel.value.includes('è‡ªå®šä¹‰')) return custom?.value?.trim() || '';
            return sel.value;
        }
        // äº‹ä»¶ç»‘å®š
        document.addEventListener('change', (e)=>{
            if (e.target?.id === 'aiProvider') { refreshModelOptions(); }
            if (e.target?.id === 'aiModelSelect') {
                const custom = aiModelInput(); const sel = aiModelSelect();
                if (custom && sel) custom.style.display = sel.value.includes('è‡ªå®šä¹‰') ? 'block' : 'none';
            }
        });

        // æ‹–æ‹½ç§»åŠ¨æ‚¬æµ®çª—
        function centerAIModal(){
            const m = document.getElementById('aiModal');
            if (!m) return;
            // å»æ‰å±…ä¸­ transformï¼Œæ”¹ä¸ºå›ºå®šä½ç½®ï¼Œæ–¹ä¾¿æ‹–åŠ¨
            const rect = m.getBoundingClientRect();
            const vw = window.innerWidth, vh = window.innerHeight;
            m.style.transform = 'none';
            m.style.left = Math.max(10, (vw - rect.width) / 2) + 'px';
            m.style.top = Math.max(10, (vh - rect.height) / 2) + 'px';
        }

        (function enableAIDrag(){
            const m = document.getElementById('aiModal');
            const header = m?.querySelector('.ai-modal-header');
            if (!m || !header) return;
            let dragging = false; let ox = 0; let oy = 0;
            // é¼ æ ‡æ‹–åŠ¨
            header.addEventListener('mousedown', (e)=>{
                dragging = true;
                const rect = m.getBoundingClientRect();
                ox = e.clientX - rect.left; oy = e.clientY - rect.top;
                document.body.style.userSelect = 'none';
            });
            document.addEventListener('mousemove', (e)=>{
                if (!dragging) return;
                const vw = window.innerWidth, vh = window.innerHeight;
                let left = e.clientX - ox; let top = e.clientY - oy;
                // è¾¹ç•Œçº¦æŸ
                left = Math.min(vw - 40, Math.max(10, left));
                top = Math.min(vh - 40, Math.max(10, top));
                m.style.left = left + 'px';
                m.style.top = top + 'px';
                m.style.transform = 'none';
            });
            document.addEventListener('mouseup', ()=>{
                dragging = false; document.body.style.userSelect = '';
            });

            // è§¦æ§/ç¬”ï¼šä½¿ç”¨ Pointer äº‹ä»¶
            if (window.PointerEvent) {
                header.addEventListener('pointerdown', (e)=>{
                    if (e.pointerType === 'mouse') return;
                    dragging = true;
                    const rect = m.getBoundingClientRect();
                    ox = e.clientX - rect.left; oy = e.clientY - rect.top;
                    m.setPointerCapture?.(e.pointerId);
                });
                header.addEventListener('pointermove', (e)=>{
                    if (!dragging || e.pointerType === 'mouse') return;
                    const vw = window.innerWidth, vh = window.innerHeight;
                    let left = e.clientX - ox; let top = e.clientY - oy;
                    left = Math.min(vw - 40, Math.max(10, left));
                    top = Math.min(vh - 40, Math.max(10, top));
                    m.style.left = left + 'px';
                    m.style.top = top + 'px';
                    m.style.transform = 'none';
                });
                header.addEventListener('pointerup', ()=>{ dragging = false; });
                header.addEventListener('pointercancel', ()=>{ dragging = false; });
            }
            window.addEventListener('resize', ()=>{
                // çª—å£å˜åŒ–æ—¶ï¼Œç¡®ä¿ä»åœ¨è§†å£å†…
                const rect = m.getBoundingClientRect();
                const vw = window.innerWidth, vh = window.innerHeight;
                let left = Math.min(vw - 40, Math.max(10, rect.left));
                let top = Math.min(vh - 40, Math.max(10, rect.top));
                m.style.left = left + 'px';
                m.style.top = top + 'px';
            });
        })();

        function handleDragStart(e) {
            draggedElement = e.target.closest('.component-item');
            if (!draggedElement) return;
            draggedElement.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'copy';
            const data = {
                type: draggedElement.dataset.type,
                name: draggedElement.dataset.name
            };
            try {
                e.dataTransfer.setData('application/json', JSON.stringify(data));
            } catch (_) {
                // æŸäº›æµè§ˆå™¨å¯èƒ½ä¸å…è®¸è‡ªå®šä¹‰ç±»å‹ï¼Œå›é€€åˆ° text/plain
                e.dataTransfer.setData('text/plain', JSON.stringify(data));
            }
        }

        function handleDragEnd() {
            if (draggedElement) draggedElement.classList.remove('dragging');
            draggedElement = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            canvas.classList.add('drag-over');
            if (e.dataTransfer) e.dataTransfer.dropEffect = 'copy';
        }

        function handleDragLeave() {
            canvas.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            canvas.classList.remove('drag-over');
            let raw = e.dataTransfer.getData('application/json') || e.dataTransfer.getData('text/plain');
            if (!raw) return;
            let payload = {};
            try { payload = JSON.parse(raw); } catch (_) { return; }
            const p2 = screenToContent(e.clientX, e.clientY);
            createPlacedComponent(payload.type, p2.x, p2.y);
        }

        // é€‰æ‹©ç»„ä»¶ä»¥ç‚¹å‡»æ”¾ç½®
        function selectItemForPlace(item) {
            clearSelection();
            selectedType = item.dataset.type;
            selectedItemEl = item;
            item.classList.add('selected');
            canvas.classList.add('placing');
        }

        function clearSelection() {
            selectedType = null;
            if (selectedItemEl) selectedItemEl.classList.remove('selected');
            selectedItemEl = null;
            canvas.classList.remove('placing');
        }

        // ç‚¹å‡»ç”»å¸ƒæ”¾ç½®
        function handleCanvasClickToPlace(e) {
            if (!selectedType) return;
            // ä»…åœ¨ç‚¹å‡»ç©ºç™½ç”»å¸ƒï¼ˆå®¹å™¨æˆ–å†…å®¹å±‚ï¼‰æ—¶æ”¾ç½®
            const valid = e.target === canvas || e.target === content;
            if (!valid) return;
            const p1 = screenToContent(e.clientX, e.clientY);
            placeAt(selectedType, p1.x, p1.y);
            // å¦‚éœ€å•æ¬¡æ”¾ç½®ï¼Œæ”¹ä¸ºï¼šclearSelection();
        }

        // ç»Ÿä¸€æ”¾ç½®å…¥å£ï¼šæ”¯æŒæ‰¹é‡ç£·è„‚ x5
        function placeAt(type, x, y) {
            // å¸é™„å¼€å¯æ—¶ï¼Œç£·è„‚ç±»è‡ªåŠ¨è·ŸéšåŒç±»ä¸Šä¸€æ¬¡çš„â€œæ°´å¹³çº¿â€ï¼ˆä¸­å¿ƒYï¼‰ï¼Œä¿æŒè¡Œå¯¹é½
            if (snapEnabled && (type === 'phospholipid-up' || type === 'phospholipid-down')) {
                const lastY = lastPhosRowY[type];
                if (lastY != null) y = lastY;
            }
            if (placeBulkCount > 1 && (type === 'phospholipid-up' || type === 'phospholipid-down')) {
                createPhospholipidRow(type, x, y, placeBulkCount);
            } else {
                createPlacedComponent(type, x, y);
            }
        }

        function createPhospholipidRow(type, centerX, centerY, count) {
            const cw = canvas.clientWidth;
            const w = PHOS_W;             // å•ä¸ªç£·è„‚å®½åº¦
            const spacing = PHOS_W;       // ä¸ç½‘æ ¼ä¸€è‡´ï¼Œåˆšå¥½å¹¶æ’
            const total = w + (count - 1) * spacing;
            // èµ·ç‚¹ä»¥è¡Œå±…ä¸­ï¼Œä¸”æ•´ä½“ä¸è¶Šç•Œ
            let startX = centerX - total / 2 + w / 2;
            startX = Math.max(w / 2, Math.min(startX, cw - (count - 1) * spacing - w / 2));

            for (let i = 0; i < count; i++) {
                const xi = startX + i * spacing;
                createPlacedComponent(type, xi, centerY);
            }
        }

        // æ‰¹é‡æ”¾ç½®åˆ‡æ¢æŒ‰é’®ï¼š5ä¸ªç£·è„‚ï¼ˆæ­£/å€’ï¼‰
        function toggleBulkPhospho(type) {
            const same = (bulkPreferredType === type && placeBulkCount === 5);
            if (same) {
                bulkPreferredType = null; placeBulkCount = 1;
            } else {
                bulkPreferredType = type; placeBulkCount = 5;
            }
            // æ›´æ–°å·¦ä¾§èŠ¯ç‰‡é«˜äº®
            const upChip = document.querySelector('.bulk-chip[data-type="phospholipid-up"]');
            const downChip = document.querySelector('.bulk-chip[data-type="phospholipid-down"]');
            if (upChip) upChip.classList.toggle('active', bulkPreferredType === 'phospholipid-up' && placeBulkCount === 5);
            if (downChip) downChip.classList.toggle('active', bulkPreferredType === 'phospholipid-down' && placeBulkCount === 5);
            // åŒæ—¶é€‰ä¸­å·¦ä¾§å¯¹åº”ç»„ä»¶ï¼Œè¿›å…¥æ”¾ç½®æ¨¡å¼
            const item = document.querySelector(`.component-item[data-type="${type}"]`);
            if (item) selectItemForPlace(item);
        }

        // åˆ›å»ºå¹¶æ”¾ç½®ç»„ä»¶åˆ°ç”»å¸ƒ
        function createPlacedComponent(type, x, y) {
            if (!componentSVGs[type]) return;
            // é¦–æ¬¡æ”¾ç½®æ—¶éšè—ç”»å¸ƒå¼•å¯¼
            document.getElementById('canvasIntro')?.classList.add('hidden');
            const el = document.createElement('div');
            el.className = 'placed-component';
            el.dataset.type = type;
            el.innerHTML = `${componentSVGs[type]}`;
            content.appendChild(el);

            // åˆå§‹ä½ç½®ï¼ˆå…ˆæ”¾ä¸­ç‚¹ï¼Œå†çŸ«æ­£ï¼‰
            const w = el.offsetWidth;
            const h = el.offsetHeight;
            const canvasRect = canvas.getBoundingClientRect(); // ç”¨äºè¾¹ç•ŒèŒƒå›´
            let left = x - w / 2;
            let top = y - h / 2;
            if (snapEnabled) {
                left = Math.round(left / GRID_SIZE) * GRID_SIZE;
                top = Math.round(top / GRID_SIZE) * GRID_SIZE;
            }
            // çº¦æŸåœ¨ç”»å¸ƒå†…
            left = Math.max(0, Math.min(left, canvas.clientWidth - w));
            top = Math.max(0, Math.min(top, canvas.clientHeight - h));
            el.style.left = left + 'px';
            el.style.top = top + 'px';

            // æ ¹æ®å¼€å…³æ§åˆ¶åŠ¨æ•ˆ
            applyMotionToElement(el);

            // ç»‘å®šäº¤äº’
            makeDraggableWithinCanvas(el);
            bindTooltip(el);
            el.addEventListener('dblclick', () => removePlacedComponent(el));

            // ç»Ÿè®¡æ›´æ–°
            incrementCount(type);

            // å¸é™„å¼€å¯æ—¶ï¼Œè®°å½•ç£·è„‚è¡Œï¼ˆä¸­å¿ƒYï¼‰ï¼Œç”¨äºåç»­ä¿æŒåŒä¸€æ°´å¹³çº¿
            if ((type === 'phospholipid-up' || type === 'phospholipid-down')) {
                const centerY = top + h / 2;
                lastPhosRowY[type] = centerY;
            }
        }

        function removePlacedComponent(el) {
            const type = el.dataset.type;
            el.remove();
            decrementCount(type);
        }

        // ä¿å­˜/åŠ è½½è‡ªå®šä¹‰ç¤ºä¾‹
        function saveCustomPreset() {
            const items = Array.from(document.querySelectorAll('#canvasContent .placed-component')).map(el => {
                const left = parseFloat(el.style.left) || 0;
                const top = parseFloat(el.style.top) || 0;
                const cx = left + el.offsetWidth / 2;
                const cy = top + el.offsetHeight / 2;
                return { type: el.dataset.type, cx, cy };
            });
            const payload = { version: 1, items };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
                alert('å·²ä¿å­˜å½“å‰ç»„è£…ä¸ºâ€œæˆ‘çš„ç¤ºä¾‹â€ã€‚');
            } catch (err) {
                console.error(err);
                alert('ä¿å­˜å¤±è´¥ï¼šè¯·æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦å…è®¸æœ¬åœ°å­˜å‚¨ã€‚');
            }
        }

        function loadCustomPreset() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) { alert('å°šæœªä¿å­˜â€œæˆ‘çš„ç¤ºä¾‹â€ã€‚'); return; }
            let data; try { data = JSON.parse(raw); } catch { alert('ç¤ºä¾‹æ•°æ®å·²æŸåã€‚'); return; }
            if (!data || !Array.isArray(data.items)) { alert('ç¤ºä¾‹æ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚'); return; }
            clearCanvas();
            data.items.forEach(it => {
                if (!it || !it.type) return;
                const cx = Number(it.cx) || 0;
                const cy = Number(it.cy) || 0;
                createPlacedComponent(it.type, cx, cy);
            });
        }

        function makeDraggableWithinCanvas(el) {
            let offsetX = 0, offsetY = 0;
            // ç”¨äºè§¦æ§/ç¬”è¯†åˆ«åŒå‡»ï¼ˆåŒå‡»ï¼‰åˆ é™¤
            if (el.__lastTapTime === undefined) el.__lastTapTime = 0;
            if (el.__lastTapX === undefined) el.__lastTapX = 0;
            if (el.__lastTapY === undefined) el.__lastTapY = 0;
            function onMouseMove(moveEvent) {
                const elW = el.offsetWidth;
                const elH = el.offsetHeight;
                const p = screenToContent(moveEvent.clientX, moveEvent.clientY);
                let left = p.x - offsetX;
                let top = p.y - offsetY;
                const isPhos = (el.dataset.type === 'phospholipid-up' || el.dataset.type === 'phospholipid-down');
                if (snapEnabled) {
                    left = Math.round(left / GRID_SIZE) * GRID_SIZE;
                    if (isPhos && lastPhosRowY[el.dataset.type] != null) {
                        top = lastPhosRowY[el.dataset.type] - elH / 2;
                    } else {
                        top = Math.round(top / GRID_SIZE) * GRID_SIZE;
                    }
                }
                left = Math.max(0, Math.min(left, canvas.clientWidth - elW));
                top = Math.max(0, Math.min(top, canvas.clientHeight - elH));
                el.style.left = left + 'px';
                el.style.top = top + 'px';
            }
            function onMouseUp() {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                if (motionEnabled) applyMotionToElement(el);
                const type = el.dataset.type;
                if (type === 'phospholipid-up' || type === 'phospholipid-down') {
                    const top = parseFloat(el.style.top) || 0;
                    const h = el.offsetHeight;
                    lastPhosRowY[type] = top + h / 2;
                }
            }
            el.addEventListener('mousedown', (downEvent) => {
                if (downEvent.button !== 0) return;
                const left0 = parseFloat(el.style.left) || 0;
                const top0 = parseFloat(el.style.top) || 0;
                const p = screenToContent(downEvent.clientX, downEvent.clientY);
                offsetX = p.x - left0;
                offsetY = p.y - top0;
                // æ‹–åŠ¨å¼€å§‹æ—¶éšè—æç¤º
                tooltip.style.display = 'none';
                // æ‹–åŠ¨è¿‡ç¨‹ä¸­ç§»é™¤åŠ¨æ•ˆï¼Œé¿å…å¹²æ‰°
                clearMotionFromElement(el);
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                downEvent.preventDefault();
            });

            // è§¦æ§/ç¬”æ‹–æ‹½ï¼ˆPointer äº‹ä»¶ï¼‰
            if (window.PointerEvent) {
                let startX = 0, startY = 0, moved = false;
                const onPointerMove = (e) => {
                    if (e.pointerType === 'mouse') return; // é¿å…ä¸é¼ æ ‡é‡å¤
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    if (Math.abs(dx) + Math.abs(dy) > 6) moved = true;
                    onMouseMove(e);
                };
                const onPointerUp = (e) => {
                    el.removeEventListener('pointermove', onPointerMove);
                    el.removeEventListener('pointerup', onPointerUp);
                    el.removeEventListener('pointercancel', onPointerUp);
                    if (!moved) {
                        // è§¦æ§åŒå‡»ï¼ˆåŒå‡»ï¼‰åˆ é™¤
                        const now = Date.now();
                        const dt = now - (el.__lastTapTime || 0);
                        const dist = Math.hypot((e.clientX - (el.__lastTapX || 0)), (e.clientY - (el.__lastTapY || 0)));
                        if (dt < 350 && dist < 12) {
                            removePlacedComponent(el);
                            return;
                        }
                        el.__lastTapTime = now;
                        el.__lastTapX = e.clientX;
                        el.__lastTapY = e.clientY;
                    }
                    if (motionEnabled) applyMotionToElement(el);
                    const type = el.dataset.type;
                    if (type === 'phospholipid-up' || type === 'phospholipid-down') {
                        const top = parseFloat(el.style.top) || 0;
                        const h = el.offsetHeight;
                        lastPhosRowY[type] = top + h / 2;
                    }
                };
                el.addEventListener('pointerdown', (e) => {
                    if (e.pointerType === 'mouse') return;
                    moved = false;
                    startX = e.clientX; startY = e.clientY;
                    const left0 = parseFloat(el.style.left) || 0;
                    const top0 = parseFloat(el.style.top) || 0;
                    const p = screenToContent(e.clientX, e.clientY);
                    offsetX = p.x - left0;
                    offsetY = p.y - top0;
                    tooltip.style.display = 'none';
                    clearMotionFromElement(el);
                    el.setPointerCapture?.(e.pointerId);
                    el.addEventListener('pointermove', onPointerMove);
                    el.addEventListener('pointerup', onPointerUp);
                    el.addEventListener('pointercancel', onPointerUp);
                    e.preventDefault();
                });
            } else {
                // æ—§è®¾å¤‡ Touch å…¼å®¹
                let startX = 0, startY = 0, moved = false;
                const onTouchMove = (te) => {
                    const t = (te.touches || [])[0]; if (!t) return;
                    const dx = t.clientX - startX;
                    const dy = t.clientY - startY;
                    if (Math.abs(dx) + Math.abs(dy) > 6) moved = true;
                    onMouseMove(t);
                    te.preventDefault();
                };
                const onTouchEnd = (te) => {
                    document.removeEventListener('touchmove', onTouchMove);
                    document.removeEventListener('touchend', onTouchEnd);
                    document.removeEventListener('touchcancel', onTouchEnd);
                    if (!moved) {
                        // åŒå‡»ï¼ˆåŒå‡»ï¼‰åˆ é™¤
                        const t = (te.changedTouches || [])[0];
                        if (t) {
                            const now = Date.now();
                            const dt = now - (el.__lastTapTime || 0);
                            const dist = Math.hypot((t.clientX - (el.__lastTapX || 0)), (t.clientY - (el.__lastTapY || 0)));
                            if (dt < 350 && dist < 12) {
                                removePlacedComponent(el);
                                return;
                            }
                            el.__lastTapTime = now;
                            el.__lastTapX = t.clientX;
                            el.__lastTapY = t.clientY;
                        }
                    }
                    if (motionEnabled) applyMotionToElement(el);
                    const type = el.dataset.type;
                    if (type === 'phospholipid-up' || type === 'phospholipid-down') {
                        const top = parseFloat(el.style.top) || 0;
                        const h = el.offsetHeight;
                        lastPhosRowY[type] = top + h / 2;
                    }
                };
                el.addEventListener('touchstart', (ts) => {
                    const t = (ts.touches || [])[0]; if (!t) return;
                    moved = false; startX = t.clientX; startY = t.clientY;
                    const left0 = parseFloat(el.style.left) || 0;
                    const top0 = parseFloat(el.style.top) || 0;
                    const p = screenToContent(t.clientX, t.clientY);
                    offsetX = p.x - left0;
                    offsetY = p.y - top0;
                    tooltip.style.display = 'none';
                    clearMotionFromElement(el);
                    document.addEventListener('touchmove', onTouchMove, { passive: false });
                    document.addEventListener('touchend', onTouchEnd);
                    document.addEventListener('touchcancel', onTouchEnd);
                }, { passive: true });
            }
        }

        // è¿åŠ¨æ§åˆ¶å‡½æ•°
        function applyMotionToElement(el) {
            if (!motionEnabled) return;
            clearMotionFromElement(el);
            if (Math.random() > 0.5) el.classList.add('floating');
            else el.classList.add('pulsing');
        }
        function clearMotionFromElement(el) {
            el.classList.remove('floating');
            el.classList.remove('pulsing');
        }
        function applyMotionToAll() {
            document.querySelectorAll('#canvasContent .placed-component').forEach(applyMotionToElement);
        }
        function clearMotionFromAll() {
            document.querySelectorAll('#canvasContent .placed-component').forEach(clearMotionFromElement);
        }
        function toggleMotion() {
            motionEnabled = !motionEnabled;
            const btn = document.getElementById('motionToggleBtn');
            if (motionEnabled) {
                btn.textContent = 'åœæ­¢è¿åŠ¨';
                btn.classList.add('active');
                applyMotionToAll();
            } else {
                btn.textContent = 'å¼€å¯è¿åŠ¨';
                btn.classList.remove('active');
                clearMotionFromAll();
            }
        }

        function bindTooltip(el) {
            const type = el.dataset.type;
            const info = componentInfo[type] || { name: type, desc: '' };
            function onEnter() { tooltip.style.display = 'block'; }
            function onMove(e) {
                const content = `<strong>${info.name}</strong><br><span style="opacity:.9">${info.desc}</span>`;
                tooltip.innerHTML = content;
                const padding = 12;
                const rect = canvas.getBoundingClientRect();
                let x = e.clientX - rect.left + padding;
                let y = e.clientY - rect.top + padding;
                // ä¿è¯ä¸è¶…å‡ºç”»å¸ƒ
                const maxX = rect.width - tooltip.offsetWidth - 8;
                const maxY = rect.height - tooltip.offsetHeight - 8;
                tooltip.style.left = Math.min(x, maxX) + 'px';
                tooltip.style.top = Math.min(y, maxY) + 'px';
            }
            function onLeave() { tooltip.style.display = 'none'; }
            el.addEventListener('mouseenter', onEnter);
            el.addEventListener('mousemove', onMove);
            el.addEventListener('mouseleave', onLeave);
        }

        // ç»Ÿè®¡é€»è¾‘
        function resetCounts() {
            componentCounts = {};
            Object.keys(typeToCounterId).forEach(t => componentCounts[t] = 0);
            updateStats();
        }

        function incrementCount(type) {
            if (!(type in componentCounts)) componentCounts[type] = 0;
            componentCounts[type]++;
            updateStats();
        }

        function decrementCount(type) {
            if (!(type in componentCounts)) return;
            componentCounts[type] = Math.max(0, componentCounts[type] - 1);
            updateStats();
        }

        function updateStats() {
            Object.entries(typeToCounterId).forEach(([type, id]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = componentCounts[type] || 0;
            });
        }

        // è§†å›¾ä¸èƒŒæ™¯æ¸²æŸ“
        let backgroundVisible = false;
        function renderMembraneBackground() {
            const bg = document.getElementById('membraneBackground');
            const width = canvas.clientWidth || 1200;
            const height = 200; // å›ºå®šèƒŒæ™¯å±‚é«˜åº¦

            if (currentView === 'side') {
                // ä¾§è§†ï¼šä¸Šä¸‹ä¸¤æ’å¤´éƒ¨ï¼›èƒŒæ™¯çº¯ç™½
                const heads = Math.max(12, Math.floor(width / 60));
                const topY = 40, bottomY = 160;
                const tailTop = 60, tailBottom = 140;
                const spacing = width / (heads + 1);

                let circlesTop = '';
                let circlesBottom = '';
                let tails = '';
                for (let i = 1; i <= heads; i++) {
                    const cx = Math.round(i * spacing);
                    circlesTop += `<circle cx="${cx}" cy="${topY}" r="8" fill="#64B5F6" opacity="0.95"/>`;
                    circlesBottom += `<circle cx="${cx}" cy="${bottomY}" r="8" fill="#64B5F6" opacity="0.95"/>`;
                    // æ³¢æµªå½¢ç–æ°´å°¾ï¼ˆçº¢è‰²ï¼‰
                    const path1 = `M ${cx-3} ${tailTop} C ${cx-6} ${tailTop+12}, ${cx} ${tailTop+24}, ${cx-3} ${tailTop+36} C ${cx-6} ${tailTop+44}, ${cx} ${tailTop+56}, ${cx-3} ${tailBottom}`;
                    const path2 = `M ${cx+3} ${tailTop} C ${cx+6} ${tailTop+12}, ${cx} ${tailTop+24}, ${cx+3} ${tailTop+36} C ${cx+6} ${tailTop+44}, ${cx} ${tailTop+56}, ${cx+3} ${tailBottom}`;
                    tails += `<path d="${path1}" stroke="#EF5350" stroke-width="2.5" fill="none" opacity="0.7"/>`;
                    tails += `<path d="${path2}" stroke="#EF5350" stroke-width="2.5" fill="none" opacity="0.7"/>`;
                }

                bg.innerHTML = `
                    <svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                        <rect x="0" y="0" width="${width}" height="${height}" fill="#ffffff"/>
                        ${tails}
                        ${circlesTop}
                        ${circlesBottom}
                    </svg>
                `;
            } else {
                // ä¿¯è§†ï¼šå¤´éƒ¨åœ¨ä¸¤ä¾§è¾¹ç¼˜çš„ç¨ å¯†åˆ†å¸ƒï¼›èƒŒæ™¯çº¯ç™½
                const cols = Math.max(16, Math.floor(width / 50));
                const rows = 4;
                const spacingX = width / (cols + 1);
                const spacingY = height / (rows + 1);
                let dots = '';
                for (let r = 1; r <= rows; r++) {
                    for (let c = 1; c <= cols; c++) {
                        const cx = Math.round(c * spacingX);
                        const cy = Math.round(r * spacingY);
                        const color = r <= 2 ? '#2196F3' : '#FF5722';
                        dots += `<circle cx="${cx}" cy="${cy}" r="6" fill="${color}" opacity="0.9"/>`;
                    }
                }
                bg.innerHTML = `
                    <svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                        <rect x="0" y="0" width="${width}" height="${height}" fill="#ffffff"/>
                        ${dots}
                    </svg>
                `;
            }
            backgroundVisible = true;
        }

        // å–æ¶ˆåˆ‡æ¢è§†è§’åŠŸèƒ½ï¼šä¿ç•™èƒŒæ™¯æ¸²æŸ“æ–¹æ³•ä»¥å¤‡å°†æ¥éœ€è¦ï¼Œä½†ä¸å†æä¾›åˆ‡æ¢å…¥å£

        function clearCanvas() {
            document.querySelectorAll('#membraneCanvas .placed-component').forEach(el => el.remove());
            resetCounts();
            // æ¸…ç©ºåè‹¥æ— å…ƒç´ ï¼Œåˆ™æ˜¾ç¤ºå¼•å¯¼
            document.getElementById('canvasIntro')?.classList.remove('hidden');
        }

        function loadPreset() {
            clearCanvas();
            // ç”Ÿæˆä¸€ç»„å…¸å‹åˆ†å¸ƒ
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;
            const midY = height / 2;

            // ä¸¤æ’ç£·è„‚ï¼ˆåŒåˆ†å­å±‚ï¼‰æ›´ç´§å‡‘ï¼šæ•°é‡è¿›ä¸€æ­¥å¢åŠ ã€å·¦å³è¾¹è·æ›´çª„
            const n = 36; // å†å¢åŠ æ•°é‡ï¼Œè¿›ä¸€æ­¥å‹ç¼©æ°´å¹³é—´è·
            const marginX = Math.max(3, Math.floor(width * 0.01)); // æ›´å°çš„å·¦å³è¾¹è·
            const usable = width - 2 * marginX;
            const spacing = usable / (n - 1);
            const deltaY = 45; // ä¸Šä¸‹å±‚è·ç¦»ç¼©åˆ° 45

            // ä¸ºä¸‰ç±»è·¨è†œè›‹ç™½é¢„ç•™ç©ºæ¡£ï¼Œé¿å…ä¸ç£·è„‚é‡å 
            const reservedXs = [width * 0.12, width * 0.50, width * 0.88];
            const reservedRadius = 45; // ç©ºæ¡£ç¨å¾®ç¼©å°ï¼Œæ•´ä½“æ›´ç´§å‡‘

            for (let i = 0; i < n; i++) {
                const x = marginX + i * spacing;
                const nearReserved = reservedXs.some(rx => Math.abs(x - rx) < reservedRadius);
                if (nearReserved) continue; // åœ¨ç©ºæ¡£ä½ç½®ä¸æ”¾ç£·è„‚
                // ä¸Šå±‚ï¼šæ­£ç½®ï¼ˆå¤´æœå¤–ï¼Œå‘ä¸Šï¼‰
                createPlacedComponent('phospholipid-up', x, midY - deltaY);
                // ä¸‹å±‚ï¼šå€’ç½®ï¼ˆå¤´æœå¤–ï¼Œå‘ä¸‹ï¼‰
                createPlacedComponent('phospholipid-down', x, midY + deltaY);
            }

            // èƒ†å›ºé†‡ï¼ˆåµŒå…¥ç–æ°´åŒºï¼‰æ›´å¯†ä¸€äº›
            for (let i = 1; i < n - 1; i += 2) {
                const x = marginX + i * spacing + (Math.random() * 10 - 5);
                const nearReserved = reservedXs.some(rx => Math.abs(x - rx) < reservedRadius - 10);
                if (nearReserved) continue;
                createPlacedComponent('cholesterol', x, midY + (Math.random() * 8 - 4));
            }

            // è·¨è†œ/é€šé“/è½½ä½“è›‹ç™½ï¼ˆè·¨è¶ŠåŒå±‚ï¼‰å°½å¯èƒ½åˆ†æ•£ï¼ˆå·¦/ä¸­/å³ï¼‰ï¼Œå„è‡ªå æ®é¢„ç•™ç©ºæ¡£
            createPlacedComponent('integral-protein', reservedXs[0], midY);
            createPlacedComponent('channel-protein',  reservedXs[1], midY);
            createPlacedComponent('carrier-protein',  reservedXs[2], midY);

            // å¤–å‘¨è›‹ç™½ï¼ˆå†…å¤–è¡¨é¢ï¼‰åˆ†æ•£åœ¨æ›´è¿œå·¦å³ï¼Œä¸”ä¸ä¸ç£·è„‚å±‚é‡å 
            createPlacedComponent('peripheral-protein', width * 0.08, midY - (deltaY + 60));
            createPlacedComponent('peripheral-protein', width * 0.92, midY + (deltaY + 60));

            // ç³–ç±»ï¼ˆå¤–ä¾§ï¼‰åˆ†æ•£ï¼šåå·¦/åå³ï¼Œä¸”æ˜æ˜¾åœ¨ç£·è„‚å±‚ä¹‹å¤–
            createPlacedComponent('glycoprotein', width * 0.28, midY - (deltaY + 90));
            createPlacedComponent('glycolipid',  width * 0.72, midY - (deltaY + 92));
            // å¤šç³–/å¯¡ç³–é“¾ï¼ˆæ›´å¤–ä¸”åˆ†æ•£ï¼‰
            createPlacedComponent('polysaccharide',  width * 0.18, midY - (deltaY + 110));
            createPlacedComponent('oligosaccharide', width * 0.82, midY - (deltaY + 120));
        }

        // åˆå§‹æ¸²æŸ“
        resetCounts();
        // èµ·å§‹ç”»æ¿ä¿æŒç©ºç™½ï¼Œä¸æ¸²æŸ“èƒŒæ™¯
        window.addEventListener('resize', () => {
            if (backgroundVisible) renderMembraneBackground();
            // è‹¥æœ€è¿‘æœªè¿›è¡Œæ‰‹åŠ¨ç¼©æ”¾ï¼Œåˆ™åœ¨çª—å£å˜åŒ–æ—¶è‡ªé€‚åº”
            if (Date.now() - lastManualZoomTs > 1000) autoFitToViewport();
        });
        // å¯ç”¨ç”»å¸ƒæ‰‹åŠ¨å°ºå¯¸è°ƒèŠ‚
        initCanvasManualResize();

        // ========= AI å­¦ä¹ åŠ©æ‰‹ =========
        const aiProviderInput = () => document.getElementById('aiProvider');
        const aiModelSelect = () => document.getElementById('aiModelSelect');
        const aiApiKeyInput = () => document.getElementById('aiApiKey');
        const aiModelInput = () => document.getElementById('aiModel');
        const aiQuestionInput = () => document.getElementById('aiQuestion');
        const aiImageInput = () => document.getElementById('aiImage');
        const aiResp = () => document.getElementById('aiResponse');
        const aiStat = () => document.getElementById('aiStatus');

        (function initAISettings(){
            try {
                let raw = localStorage.getItem(AI_SETTINGS_KEY);
                // å¦‚æœ¬åœ°æœªä¿å­˜è®¾ç½®ï¼Œå†…ç½®ä¸€ä»½ DeepSeek é»˜è®¤é…ç½®ï¼ˆä»…æœ¬åœ°ä½¿ç”¨ï¼‰
                if (!raw) {
                    const preset = {
                        provider: 'deepseek',
                        model: 'deepseek-chat',
                        apiKey: 'sk-626c6ff8cdef4c5e82280a39bd8ea71a'
                    };
                    try { localStorage.setItem(AI_SETTINGS_KEY, JSON.stringify(preset)); } catch(_){}
                    raw = JSON.stringify(preset);
                }
                const s = JSON.parse(raw);
                if (s.provider && aiProviderInput()) aiProviderInput().value = s.provider;
                // åˆå§‹åŒ–æ¨¡å‹ä¸‹æ‹‰
                refreshModelOptions();
                if (s.model) applyModelToUI(s.model);
                if (s.apiKey && aiApiKeyInput()) aiApiKeyInput().value = s.apiKey;
            } catch(_){}
        })();

        function saveAISettings(){
            const provider = aiProviderInput()?.value || 'deepseek';
            const model = readModelFromUI() || '';
            const apiKey = aiApiKeyInput()?.value?.trim() || '';
            localStorage.setItem(AI_SETTINGS_KEY, JSON.stringify({ provider, model, apiKey }));
            if (aiStat()) aiStat().textContent = `è®¾ç½®å·²ä¿å­˜ï¼ˆæä¾›å•†ï¼š${provider}ï¼‰`;
        }

        function toBase64(file){
            return new Promise((resolve,reject)=>{
                const r = new FileReader();
                r.onload = () => resolve(r.result);
                r.onerror = reject;
                r.readAsDataURL(file);
            });
        }

        async function askAI(){
            const q = (aiQuestionInput()?.value || '').trim();
            const file = aiImageInput()?.files?.[0] || null;
            let provider = (aiProviderInput()?.value) || '';
            if (!provider) provider = /deepseek/i.test(model) ? 'deepseek' : 'ark';
            const model = readModelFromUI() || (provider==='deepseek' ? 'deepseek-chat' : 'doubao-seed-1-6-250615');
            const apiKey = aiApiKeyInput()?.value?.trim();
            if (!q && !file){
                if (aiStat()) aiStat().textContent = 'è¯·è‡³å°‘è¾“å…¥é—®é¢˜æˆ–ä¸Šä¼ ä¸€å¼ å›¾ç‰‡';
                return;
            }
            if (aiResp()) { aiResp().style.display='block'; aiResp().textContent = 'æ­£åœ¨æ€è€ƒä¸­â€¦'; }
            if (aiStat()) aiStat().textContent = apiKey ? `æ­£åœ¨è¯·æ±‚ ${provider==='deepseek' ? 'DeepSeek' : 'ç«å±±å¼•æ“ Ark'} â€¦` : 'æœªå¡«å†™å¯†é’¥ï¼Œç”Ÿæˆæœ¬åœ°ç¤ºèŒƒè§£ç­”â€¦';

            try {
                let image_b64 = null;
                if (file) image_b64 = await toBase64(file);
                // å…ˆæ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯
                appendMessage('user', { text: q, image: image_b64 });
                document.getElementById('aiQuestion').value = '';
                if (aiImageInput()) aiImageInput().value = '';
                showTyping();

                if (!apiKey){
                    // æœ¬åœ°ç¤ºèŒƒï¼šç»“åˆå½“å‰ç”»å¸ƒç»Ÿè®¡ï¼Œç»™å‡ºå¼•å¯¼æ€§å›ç­”
                    const stats = Object.entries(typeToCounterId).map(([t,id])=>`${t}:${document.getElementById(id)?.textContent||0}`).join(' ');
                    const demo = `ç¤ºèŒƒå›ç­”ï¼ˆæœ¬åœ°ç”Ÿæˆï¼Œæœªè°ƒç”¨APIï¼‰\nä½ çš„é—®é¢˜ï¼š${q || 'ï¼ˆæ— æ–‡æœ¬ï¼Œä»…å›¾ç‰‡ï¼‰'}\nç»„ä»¶ç»Ÿè®¡ï¼š${stats}\nå»ºè®®ï¼š\n1) å…ˆå®ŒæˆåŒåˆ†å­å±‚çš„è¿ç»­æ€§ï¼Œå†æ·»åŠ é€šé“/è½½ä½“è›‹ç™½åˆ†æ•£åˆ†å¸ƒã€‚\n2) ç³–è›‹ç™½/ç³–è„‚åº”ä½äºå¤–ä¾§ï¼Œé•¿åº¦å¯æ ¹æ®ä»»åŠ¡è¦æ±‚å¢å‡ã€‚\n3) è‹¥ä¸ç¡®å®šæŸç»„ä»¶ä½ç½®ï¼Œå¯ä¸Šä¼ æˆªå›¾è®©AIæ ‡æ³¨æ ¡æ­£ã€‚`;
                    aiResp().textContent = demo;
                    return;
                }
                if (provider==='deepseek'){
                    // DeepSeek: OpenAIå…¼å®¹ Chat Completions
                    const dsBody = {
                        model: model || 'deepseek-chat',
                        messages: [
                            { role: 'system', content: 'You are a helpful assistant for biology membrane modeling.' },
                            { role: 'user', content: q || '(æ— æ–‡æœ¬)' }
                        ],
                        stream: false
                    };
                    if (image_b64) {
                        appendMessage('ai', { text: 'æç¤ºï¼šå½“å‰ DeepSeek æ–‡æœ¬æ¨¡å‹å°†å¿½ç•¥ä¸Šä¼ å›¾ç‰‡ã€‚å¦‚éœ€è§†è§‰åˆ†æè¯·åˆ‡æ¢ Ark å¤šæ¨¡æ€ã€‚' });
                    }
                    const dsRes = await fetch(DEEPSEEK_ENDPOINT_DEFAULT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(dsBody)
                    });
                    if (!dsRes.ok){
                        const t = await dsRes.text();
                        throw new Error(`DeepSeeké”™è¯¯: ${dsRes.status} ${t}`);
                    }
                    const dsData = await dsRes.json();
                    const answer = dsData.choices?.[0]?.message?.content || JSON.stringify(dsData, null, 2);
                    hideTyping();
                    appendMessage('ai', { text: answer });
                    aiStat().textContent = 'å·²å®Œæˆ';
                    return;
                } else {
                    // ç«å±±å¼•æ“ Arkï¼ˆtype: text / image_urlï¼‰
                    const arkBody = {
                        model: model,
                        messages: [{
                            role: 'user',
                            content: [
                                ...(q ? [{ type: 'text', text: q }] : []),
                                ...(image_b64 ? [{ type: 'image_url', image_url: { url: image_b64 } }] : [])
                            ]
                        }]
                    };
                    const arkRes = await fetch(ARK_ENDPOINT_DEFAULT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(arkBody)
                    });
                    if (!arkRes.ok){
                        const t = await arkRes.text();
                        throw new Error(`Arké”™è¯¯: ${arkRes.status} ${t}`);
                    }
                    const arkData = await arkRes.json();
                    let answer = '';
                    try {
                        const msg = arkData.choices?.[0]?.message;
                        if (Array.isArray(msg?.content)) answer = msg.content.map(p=>p.text||'').join('\n').trim();
                        else answer = msg?.content || '';
                    } catch(_){}
                    if (!answer) answer = JSON.stringify(arkData, null, 2);
                    hideTyping();
                    appendMessage('ai', { text: answer });
                    aiStat().textContent = 'å·²å®Œæˆ';
                    return;
                }
            } catch(err){
                hideTyping();
                appendMessage('ai', { text: `è¯·æ±‚å¤±è´¥ï¼š${err.message}` });
                aiStat().textContent = 'è¯·æ£€æŸ¥ç½‘ç»œã€APIåœ°å€æˆ–å¯†é’¥è®¾ç½®';
            }
        }

        function clearAI(){
            if (aiQuestionInput()) aiQuestionInput().value = '';
            if (aiImageInput()) aiImageInput().value = '';
            if (aiResp()) { aiResp().style.display='none'; aiResp().textContent=''; }
            if (aiStat()) aiStat().textContent = 'å·²æ¸…ç©º';
        }

        // ç¡®ä¿å¯åŠ¨æ—¶ä¸å¼¹å‡º AI åŠ©æ‰‹ï¼ˆå®‰å…¨å…œåº•ï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            const m = document.getElementById('aiModal');
            const b = document.getElementById('aiBackdrop');
            const container = document.querySelector('.container');
            if (m) { m.style.display = 'none'; m.classList.remove('page-mode'); }
            if (b) { b.style.display = 'none'; }
            if (container) { container.classList.remove('hidden'); }
        });
    </script>
</body>
</html>
